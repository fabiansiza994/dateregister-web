<div class="bg-white rounded-2xl shadow-card border border-slate-200/70 p-4">
<div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
  <div>
    <h3 class="fw-semibold mb-0">Grupos</h3>
    <small class="text-secondary">Administra los grupos de trabajo</small>
  </div>
</div>

@if (error()) {
  <div class="alert alert-danger d-flex align-items-start gap-2" role="alert">
    <i class="bi bi-exclamation-triangle mt-1"></i>
    <div class="flex-grow-1">{{ error() }}</div>
    <button class="btn-close ms-auto" (click)="error.set(null)"></button>
  </div>
}
@if (success()) {
  <div class="alert alert-success d-flex align-items-start gap-2" role="alert">
    <i class="bi bi-check-circle mt-1"></i>
    <div class="flex-grow-1">{{ success() }}</div>
    <button class="btn-close ms-auto" (click)="success.set(null)"></button>
  </div>
}

<!-- Crear -->
<form class="card border-0 shadow-sm rounded-4 mb-3" (submit)="$event.preventDefault(); create()">
  <div class="card-body">
    <div class="row g-2 align-items-end">
      <div class="col-md-8">
        <label class="form-label">Nuevo grupo</label>
        <input class="form-control"
               placeholder="Ej: Administradores, Comercial..."
               [ngModel]="newName()"
               (ngModelChange)="newName.set($event)"
               name="newGroupName"
               [disabled]="creating() || loading()">
      </div>
      <div class="col-md-4">
        <button class="btn btn-success w-100" [disabled]="!canCreate() || loading()">
          @if (creating()) { <span class="spinner-border spinner-border-sm me-2"></span> }
          Crear grupo
        </button>
      </div>
    </div>
  </div>
</form>



<!-- Tabla -->
<div class="table-responsive shadow-sm rounded-4">
  <table class="table table-hover align-middle mb-0">
    <thead class="table-light sticky-top">
      <tr>
        <th style="width:80px;">#</th>
        <th (click)="changeSort('id')" role="button" class="text-nowrap">ID</th>
        <th (click)="changeSort('nombre')" role="button">Nombre</th>
        <th style="width: 220px;">Acciones</th>
      </tr>
    </thead>
    <tbody>
      @if (loading()) {
        <tr>
          <td colspan="4" class="text-center py-4">
            <div class="d-inline-flex align-items-center gap-2 text-secondary">
              <span class="spinner-border spinner-border-sm"></span> Cargando…
            </div>
          </td>
        </tr>
      } @else {
        @if (visibleWithRow().length === 0) {
          <tr>
            <td colspan="4" class="text-center py-4 text-secondary">
              No hay grupos para mostrar.
            </td>
          </tr>
        } @else {
          @for (g of visibleWithRow(); track g.id) {
            <tr>
              <td class="text-secondary">{{ g.rowNumber }}</td>
              <td class="text-monospace">{{ g.id }}</td>
              <td>
                @if (editingId() === g.id) {
                  <input class="form-control form-control-sm"
                         [ngModel]="editName()"
                         (ngModelChange)="editName.set($event)"
                         name="editName-{{g.id}}"
                         autocomplete="off">
                } @else {
                  <span class="fw-semibold">{{ g.nombre }}</span>
                }
              </td>
              <td>
                @if (editingId() === g.id) {
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-success"
                            (click)="saveEdit(g)"
                            [disabled]="savingRowId() === g.id || !editName().trim()">
                      @if (savingRowId() === g.id) {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                      }
                      Guardar
                    </button>
                    <button class="btn btn-light" (click)="cancelEdit()" [disabled]="savingRowId() === g.id">
                      Cancelar
                    </button>
                  </div>
                } @else {
                  <div class="btn-group btn-group-sm">
                 
                    <button class="btn btn-outline-primary" (click)="startEdit(g)">
                      <i class="bi bi-pencil"></i> Editar
                    </button>
                    <button class="btn btn-outline-danger" (click)="openConfirm(g)" [disabled]="loading()">
                      <i class="bi bi-trash"></i> Eliminar
                    </button>
                  </div>
                }
              </td>
            </tr>
          }
        }
      }
    </tbody>
  </table>
</div>

<!-- Footer paginación -->
<div class="d-flex justify-content-between align-items-center mt-3">
  <div class="text-secondary small">
    Mostrando {{ firstItemIndex() }}–{{ lastItemIndex() }} de {{ total() }}
  </div>
  <div class="btn-group">
    <button class="btn btn-outline-secondary btn-sm" (click)="prevPage()" [disabled]="page()<=1 || loading()">«</button>
    <button class="btn btn-outline-secondary btn-sm" disabled>{{ page() }}/{{ totalPages() }}</button>
    <button class="btn btn-outline-secondary btn-sm" (click)="nextPage()" [disabled]="page()>=totalPages() || loading()">»</button>
  </div>
</div>

<!-- Modal Confirmación -->
<div class="modal fade"
     tabindex="-1"
     [class.show]="confirmOpen()"
     [style.display]="confirmOpen() ? 'block' : 'none'"
     aria-modal="true" role="dialog">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg rounded-4 border-0">
      <div class="modal-header border-0">
        <h5 class="modal-title">
          <i class="bi bi-trash me-2 text-danger"></i>
          Confirmar eliminación
        </h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="closeConfirm()"></button>
      </div>

      <div class="modal-body">
        @if (groupToDelete()) {
          <p class="mb-1">
            ¿Eliminar el grupo <span class="fw-semibold">{{ groupToDelete()?.nombre }}</span>?
          </p>
          <p class="small text-secondary mb-0">Esta acción no se puede deshacer.</p>
        } @else {
          <p>¿Seguro que deseas eliminar este grupo?</p>
        }
      </div>

      <div class="modal-footer border-0">
        <button type="button" class="btn btn-light" (click)="closeConfirm()" [disabled]="loading()">Cancelar</button>
        <button type="button" class="btn btn-danger" (click)="confirmDelete()" [disabled]="loading()">
          @if (loading()) { <span class="spinner-border spinner-border-sm me-2"></span> }
          Eliminar
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="confirmOpen()" *ngIf="confirmOpen()"></div>
</div>
