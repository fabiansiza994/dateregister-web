<!-- Chispas container -->
<div class="dr-sparks-container pointer-events-none fixed inset-0 z-[70]"></div>

<!-- Header (solo desktop) -->
<div class="hidden md:flex flex-wrap items-center justify-between mb-6 gap-4">
    <div class="space-y-1">
        <h3 class="text-xl font-semibold m-0">Clientes</h3>
        <p class="text-xs text-slate-500 m-0">Busca por nombre o identificación y administra tus clientes</p>
    </div>
</div>

<!-- Topbar móvil pegado al menú superior (azul) -->
<div class="md:hidden dr-mobile-topbar dr-sticky-under-nav mb-2">
    <div class="px-3 pt-3 pb-3">
        <form (submit)="$event.preventDefault(); onSearch()">
            <div class="dr-search-wrap">
                <button type="submit" class="dr-search-btn-inside" [disabled]="loading()" aria-label="Buscar"><i class="bi bi-search"></i></button>
                <input id="q-mobile-clientes" type="text" class="form-control" placeholder="Nombre o identificación" [(ngModel)]="searchName" name="searchName" (keyup.enter)="onSearch()" autocomplete="off">
                @if (searchName.length>0 || searchDoc.length>0) { <button type="button" class="dr-search-btn-right" (click)="clearFilters()" [disabled]="loading()" aria-label="Limpiar"><i class="bi bi-x"></i></button> }
            </div>
        </form>
    </div>
    <div class="px-3 pb-3 flex items-center justify-between gap-2 text-xs">
        <div class="text-white/80">Mostrando {{ firstItemIndex() }}–{{ lastItemIndex() }} de {{ total() }}</div>
        <div class="flex items-center gap-2 relative">
            <button type="button" class="btn btn-outline-light text-white btn-sm inline-flex items-center gap-1 dr-sort-btn" (click)="sortMenuOpenMobile.set(!sortMenuOpenMobile())" aria-haspopup="listbox" [attr.aria-expanded]="sortMenuOpenMobile()">
                <i class="bi bi-arrow-down-up"></i>
                <span>Sort by</span>
            </button>
            @if (sortMenuOpenMobile()) {
                <div class="dr-sort-dropdown" role="listbox">
                    <button type="button" class="dr-sort-item" [class.is-active]="sortBy()==='id'" (click)="chooseSort('id')">ID</button>
                    <button type="button" class="dr-sort-item" [class.is-active]="sortBy()==='nombre'" (click)="chooseSort('nombre')">Nombre</button>
                </div>
            }
        </div>
    </div>
</div>

@if (error()) {
<div class="rounded-lg border border-red-300 bg-red-50 text-red-700 px-4 py-3 text-sm flex gap-3 items-start mb-5" role="alert">
    <i class="bi bi-exclamation-triangle mt-1"></i>
    <div class="font-medium flex-1">{{ error() }}</div>
    <button type="button" class="btn btn-close" (click)="error.set(null)" aria-label="Cerrar"></button>
</div>
}

<!-- Filtros (solo desktop) -->
<form (submit)="$event.preventDefault(); onSearch()" class="hidden md:block bg-white rounded-2xl shadow-card mb-6 border border-slate-200/60 md:static">
    <div class="p-5 pt-4">
        <div class="grid grid-cols-12 gap-3 md:gap-5 items-end">
            <!-- Nombre + Documento + Acciones agrupados: móvil mantiene inputs individuales, en desktop se muestran en una sola fila -->
            <div class="col-span-12 space-y-1 min-w-0">
                <label class="text-sm font-medium text-slate-700 hidden md:block">Buscar</label>
                <!-- móvil: inputs separados ya no se muestran; se usa topbar azul -->
                <div class="md:hidden"></div>

                <!-- desktop: inputs y botones juntos -->
                <div class="hidden md:flex items-center gap-2 w-full">
                    <input id="searchName" type="text" class="form-control" placeholder="Ej: Juan Pérez" [(ngModel)]="searchName" name="searchName" (keyup.enter)="onSearch()" autocomplete="off">
                    <input id="searchDoc" type="text" class="form-control w-56" placeholder="Ej: 123456789" [(ngModel)]="searchDoc" name="searchDoc" (keyup.enter)="onSearch()" autocomplete="off">
                    <button type="submit" class="btn btn-primary" [disabled]="loading()"><i class="bi bi-search"></i><span class="ml-1">Buscar</span></button>
                    <button type="button" class="btn btn-outline-secondary" (click)="clearFilters()" [disabled]="loading()"><i class="bi bi-eraser"></i><span class="ml-1">Limpiar</span></button>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Botón crear: entre filtro y tabla (solo desktop) -->
<div class="hidden md:block mb-3" #createAnchor>
    <a class="btn btn-primary" routerLink="/clientes/nuevo" (click)="sparkClick($event)"><i class="bi bi-person-plus"></i><span class="ml-1">Crear cliente</span></a>
 </div>

<!-- DESKTOP: contenedor único con headbar + tabla (como Trabajos) -->
<div class="hidden md:block rounded-2xl shadow-card overflow-hidden border border-slate-200/70 bg-white">
    <div class="dr-table-headbar flex items-center justify-between gap-3 px-4 py-3 border-b border-slate-200/70 bg-slate-50">
        <div class="text-xs text-slate-600">Mostrando {{ firstItemIndex() }}–{{ lastItemIndex() }} de {{ total() }}</div>
        <div class="flex items-center gap-2">
            <div class="relative">
                <button type="button" class="btn btn-outline-secondary btn-sm inline-flex items-center gap-1" (click)="sortMenuOpenDesktop.set(!sortMenuOpenDesktop())" aria-haspopup="listbox" [attr.aria-expanded]="sortMenuOpenDesktop()">
                    <i class="bi bi-arrow-down-up"></i>
                    <span>Sort by</span>
                </button>
                @if (sortMenuOpenDesktop()) {
                    <div class="dr-sort-dropdown" role="listbox">
                        <button type="button" class="dr-sort-item" [class.is-active]="sortBy()==='id'" (click)="chooseSort('id')">ID</button>
                        <button type="button" class="dr-sort-item" [class.is-active]="sortBy()==='nombre'" (click)="chooseSort('nombre')">Nombre</button>
                    </div>
                }
            </div>
            <label class="text-xs text-slate-600">/ pág:</label>
            <select class="form-control w-20 text-xs" [ngModel]="pageSize()" (ngModelChange)="setPageSize($event)" name="pageSize">
                <option *ngFor="let s of pageSizeOptions" [value]="s">{{ s }}</option>
            </select>
            <div class="ml-2 flex items-center gap-1">
                <button type="button" class="btn btn-outline-secondary btn-sm" (click)="prevPage()" [disabled]="page()<=1 || loading()" aria-label="Anterior"><i class="bi bi-chevron-left"></i></button>
                <span class="px-2 py-1 text-xs border rounded-md bg-slate-50">{{ page() }}/{{ totalPages() }}</span>
                <button type="button" class="btn btn-outline-secondary btn-sm" (click)="nextPage()" [disabled]="page()>=totalPages() || loading()" aria-label="Siguiente"><i class="bi bi-chevron-right"></i></button>
            </div>
        </div>
    </div>
    <table class="table-modern align-middle">
        <thead>
            <tr>
                <th class="px-3 py-2 w-[60px]">#</th>
                <th class="px-3 py-2">Nombre</th>
                <th class="px-3 py-2">Identificación</th>
                <th class="px-3 py-2">Email</th>
                <th class="px-3 py-2">Teléfono</th>
                <th class="px-3 py-2">Estado</th>
                <th class="px-3 py-2 w-[160px]">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @if (loading()) {
                <tr>
                    <td colspan="7" class="text-center px-3 py-6">
                        <div class="inline-flex items-center gap-2 text-slate-500"><span class="spinner-border spinner-border-sm"></span> Cargando…</div>
                    </td>
                </tr>
            } @else {
                @if (visibleWithRow().length === 0) {
                    <tr>
                        <td colspan="7" class="text-center px-3 py-6 text-slate-500">No se encontraron clientes con los filtros aplicados.</td>
                    </tr>
                } @else {
                    @for (c of visibleWithRow(); track c.id) {
                    <tr>
                        <td class="px-3 py-2 text-xs text-slate-500">{{ c.rowNumber }}</td>
                        <td class="px-3 py-2 font-semibold">
                            <i class="bi bi-person-circle text-slate-400 mr-1"></i>{{ c.nombre }} {{ c.apellido || '' }}
                        </td>
                        <td class="px-3 py-2 font-mono">{{ c.identificacion }}</td>
                        <td class="px-3 py-2">
                            {{ c.email }}
                            @if (!c.email) { <span>—</span> }
                        </td>
                        <td class="px-3 py-2">{{ c.telefono || '—' }}</td>
                        <td class="px-3 py-2">
                            <span class="px-2 py-0.5 rounded-full text-[11px] font-medium" [class.bg-green-100]="c.estado==='ACTIVO'" [class.text-green-700]="c.estado==='ACTIVO'" [class.bg-slate-200]="c.estado!=='ACTIVO'" [class.text-slate-600]="c.estado!=='ACTIVO'">{{ c.estado }}</span>
                        </td>
                        <td class="px-3 py-2">
                            <div class="flex flex-wrap gap-2">
                                <button class="btn btn-outline-secondary btn-sm" (click)="verCliente(c)"><i class="bi bi-eye"></i></button>
                                <button class="btn btn-outline-primary btn-sm" (click)="editarCliente(c)"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-outline-danger btn-sm" (click)="openConfirm(c)" [disabled]="loading()"><i class="bi bi-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                    }
                }
            }
        </tbody>
    </table>
</div>

<!-- MOBILE -->
<div class="md:hidden">
    @if (loading()) {
    <div class="text-center py-6 text-slate-500">
        <div class="inline-flex items-center gap-2"><span class="spinner-border spinner-border-sm"></span> Cargando…</div>
    </div>
    } @else {
        @if (visibleWithRow().length === 0) {
        <div class="rounded-lg border border-slate-300 bg-slate-50 text-center text-slate-500 px-4 py-3 text-sm">No se encontraron clientes con los filtros aplicados.</div>
        } @else {
        <!-- Lista estilo WhatsApp (móvil) -->
        <div class="bg-white rounded-2xl shadow-card border border-slate-200/60 overflow-hidden">
            <div class="divide-y">
                @for (c of visibleWithRow(); track c.id) {
                <div class="dr-wa-item" (click)="verCliente(c)" tabindex="0" role="button" [attr.data-client-id]="c.id">
                    <div class="dr-wa-avatar" aria-hidden="true"><i class="bi bi-person"></i></div>
                    <div class="dr-wa-main">
                        <div class="dr-wa-row1">
                            <div class="dr-wa-title truncate">{{ c.nombre }} {{ c.apellido || '' }}</div>
                            <div class="dr-wa-date">{{ c.identificacion }}</div>
                        </div>
                        <div class="dr-wa-row2">
                            <div class="dr-wa-subtitle truncate">
                                @if (c.telefono) { <span>Tel: {{ c.telefono }}</span> }
                                @if (c.email) { <span class="mx-1 text-slate-400">•</span><a [href]="'mailto:' + c.email" class="text-primary hover:underline break-all">{{ c.email }}</a> }
                            </div>
                            <div class="dr-wa-actions">
                                <button type="button" class="dr-wa-action is-view" aria-label="Ver" (click)="$event.stopPropagation(); verCliente(c)"><i class="bi bi-eye"></i></button>
                                <button type="button" class="dr-wa-action is-edit" aria-label="Editar" (click)="$event.stopPropagation(); editarCliente(c)"><i class="bi bi-pencil"></i></button>
                                <button type="button" class="dr-wa-action is-delete" aria-label="Eliminar" (click)="$event.stopPropagation(); openConfirm(c)" [disabled]="loading()"><i class="bi bi-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                }
            </div>
        </div>
        }
    }
</div>

<!-- Modal Confirmación -->
@if (confirmOpen()) {
<div class="fixed inset-0 z-[60] flex items-center justify-center">
    <div class="fixed inset-0 bg-black/40 z-[55]" (click)="closeConfirm()"></div>
    <div class="relative w-full max-w-md mx-auto z-[65]">
        <div class="bg-white rounded-2xl shadow-card p-5 border border-slate-200/70">
            <div class="flex items-start justify-between mb-3">
                <h5 class="font-semibold flex items-center gap-2 text-red-600 m-0"><i class="bi bi-trash"></i><span>Confirmar eliminación</span></h5>
                <button type="button" (click)="closeConfirm()" class="btn btn-close" aria-label="Cerrar"></button>
            </div>
            <div class="space-y-2 text-sm">
                @if (clientToDelete()) {
                    <p class="m-0">¿Eliminar al cliente <span class="font-semibold">{{ clientToDelete()?.nombre }} {{ clientToDelete()?.apellido || '' }}</span>?</p>
                    <p class="m-0 text-slate-500 text-xs">Esta acción no se puede deshacer.</p>
                } @else {
                    <p class="m-0">¿Seguro que deseas eliminar este cliente?</p>
                }
            </div>
                        <div class="flex justify-end gap-2 mt-5">
                <button type="button" (click)="closeConfirm()" [disabled]="loading()" class="btn btn-outline-secondary">Cancelar</button>
                                <button type="button" (click)="sparkClick($event, '#dc3545'); confirmDelete()" [disabled]="loading()" class="btn btn-danger">
                    @if (loading()) { <span class="spinner-border spinner-border-sm mr-2"></span> }
                    Eliminar
                </button>
            </div>
        </div>
    </div>
</div>
}

<!-- Paginación -->
@if (total() > 10) {
  <nav class="dr-sticky-pager md:static bg-white mt-4 mb-24 md:mb-0 rounded-xl border md:border-0 border-slate-200/70 shadow-sm md:shadow-none px-4 py-2 flex items-center justify-between text-sm">
      <div class="text-slate-600">
          Mostrando {{ firstItemIndex() }}–{{ lastItemIndex() }} de {{ total() }}
      </div>
      <div class="flex items-center gap-2">
          <button class="btn btn-light btn-sm" (click)="prevPage()" [disabled]="page() <= 1">Anterior</button>
          <div class="text-xs text-slate-500">Página {{ page() }} / {{ totalPages() }}</div>
          <button class="btn btn-light btn-sm" (click)="nextPage()" [disabled]="page() >= totalPages()">Siguiente</button>
      </div>
  </nav>
}

<!-- FAB crear cliente (móvil) -->
<div class="md:hidden">
    @if (showCreateFab()) {
        <a class="btn btn-primary dr-create-fab" routerLink="/clientes/nuevo" (click)="sparkClick($event)" aria-label="Crear cliente">
            <i class="bi bi-person-plus"></i>
        </a>
    }
    <!-- pequeño offset extra por seguridad -->
    <div class="h-16"></div>
</div>
