<!-- Header -->
<div class="flex flex-wrap items-center justify-between mb-6 gap-4">
  <div class="space-y-1">
    <h3 class="text-xl font-semibold m-0 py-3">Detalle de cliente</h3>
    <p class="text-xs text-slate-500 m-0">Información del cliente y sus pacientes asociados</p>
  </div>
  <div>
    <a class="btn btn-outline-secondary" (click)="volver()">&larr; Volver a clientes</a>
  </div>
</div>

<ng-container *ngIf="error() as err">
  <div class="rounded-lg border border-red-300 bg-red-50 text-red-700 px-4 py-3 text-sm flex gap-3 items-start mb-5" role="alert">
    <i class="bi bi-exclamation-triangle mt-1"></i>
    <div class="font-medium flex-1">{{ err }}</div>
    <button type="button" class="btn btn-close" aria-label="Cerrar" (click)="error.set(null)"></button>
  </div>
</ng-container>

<ng-container *ngIf="loading(); else loaded"></ng-container>
<ng-template #loaded>
  <ng-container *ngIf="cliente() as c; else notFound">
    <div class="bg-white rounded-2xl shadow-card border border-slate-200/60 mb-6">
      <div class="p-5">
        <div class="flex items-start justify-between">
          <div>
            <h5 class="m-0 font-semibold flex items-center gap-2">
              <i class="bi bi-person-vcard-fill text-slate-400"></i>
              <span>{{ c.nombre }} <span class="font-normal">{{ c.apellido }}</span></span>
            </h5>
            <div class="text-xs text-slate-500 mt-1">ID: {{ c.id }} · Identificación: <span class="font-mono">{{ c.identificacion }}</span></div>
          </div>
          <span class="px-2 py-0.5 rounded-full text-[11px] font-medium self-start" [class.bg-green-100]="c.estado==='ACTIVO'" [class.text-green-700]="c.estado==='ACTIVO'" [class.bg-slate-200]="c.estado!=='ACTIVO'" [class.text-slate-600]="c.estado!=='ACTIVO'">{{ c.estado }}</span>
        </div>
        <hr class="my-4 border-slate-200">
        <div class="grid gap-4 md:grid-cols-3 text-sm">
          <div>
            <div class="text-slate-500">Email</div>
            <div>
              <a *ngIf="c.email" [href]="'mailto:' + c.email" class="text-primary hover:underline">{{ c.email }}</a>
              <span *ngIf="!c.email">—</span>
            </div>
          </div>
          <div>
            <div class="text-slate-500">Teléfono</div>
            <div>{{ c.telefono || '—' }}</div>
          </div>
          <div>
            <div class="text-slate-500">Dirección</div>
            <div>{{ c.direccion || '—' }}</div>
          </div>
          <div>
            <div class="text-slate-500">Razón Social</div>
            <div>{{ c.razonSocial || '—' }}</div>
          </div>
          <div class="md:col-span-3" *ngIf="c.rut || c.camaraComercio">
            <div class="text-slate-500 mb-1">Documentos</div>
            <div class="flex flex-wrap gap-2 text-xs">
              <button *ngIf="c.rut" type="button" (click)="openPdf(c.rut, 'RUT')" class="inline-flex items-center gap-1 px-2 py-1 rounded-lg border border-slate-200 hover:border-primary hover:bg-primary/5"><i class="bi bi-file-earmark-pdf text-danger"></i><span>RUT</span></button>
              <button *ngIf="c.camaraComercio" type="button" (click)="openPdf(c.camaraComercio, 'Cámara de Comercio')" class="inline-flex items-center gap-1 px-2 py-1 rounded-lg border border-slate-200 hover:border-primary hover:bg-primary/5"><i class="bi bi-file-earmark-pdf text-danger"></i><span>Cámara de Comercio</span></button>
            </div>
          </div>
        </div>
        <!-- PDF Modal -->
        <div *ngIf="pdfModalOpen()" class="fixed inset-0 z-[80] flex items-center justify-center">
          <div class="fixed inset-0 bg-black/50" (click)="closePdf()"></div>
          <div class="relative w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-card border border-slate-200 flex flex-col h-[80vh] max-h-[90vh]">
            <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
              <h5 class="m-0 font-semibold flex items-center gap-2"><i class="bi bi-file-earmark-pdf text-danger"></i><span>{{ pdfModalTitle() }}</span></h5>
              <div class="flex items-center gap-2">
                <a *ngIf="pdfSanitizedUrl()" [href]="pdfObjectUrl" download="{{ pdfModalTitle() }}.pdf" class="btn btn-sm btn-outline-primary"><i class="bi bi-download"></i> Descargar</a>
                <button type="button" class="btn btn-sm btn-outline-secondary" (click)="closePdf()"><i class="bi bi-x-lg"></i></button>
              </div>
            </div>
            <div class="flex-1 relative bg-slate-50">
              <ng-container *ngIf="pdfLoading(); else pdfLoaded">
                <div class="absolute inset-0 flex items-center justify-center text-slate-500 text-sm gap-2">
                  <span class="spinner-border spinner-border-sm"></span><span>Cargando PDF…</span>
                </div>
              </ng-container>
              <ng-template #pdfLoaded>
                <div *ngIf="pdfError() as perr" class="absolute inset-0 flex items-center justify-center text-danger text-sm">{{ perr }}</div>
                <iframe *ngIf="pdfSanitizedUrl()" [src]="pdfSanitizedUrl()" class="absolute inset-0 w-full h-full" title="Vista PDF" frameborder="0"></iframe>
                <div *ngIf="!pdfSanitizedUrl() && !pdfError()" class="absolute inset-0 flex items-center justify-center text-slate-500 text-sm">No se pudo cargar el documento.</div>
              </ng-template>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Pacientes (solo salud) -->
    <ng-container *ngIf="sector() === 'SALUD'">
      <div class="flex items-center justify-between mb-3">
        <h5 class="m-0 font-semibold">Pacientes</h5>
        <small class="text-slate-500">Total: {{ totalPacientes() }}</small>
      </div>
      <div class="hidden md:block rounded-2xl shadow-card overflow-hidden border border-slate-200/70 bg-white">
        <table class="w-full text-sm align-middle">
          <thead class="bg-slate-100 text-slate-700">
            <tr>
              <th class="px-3 py-2 w-[70px]">#</th>
              <th class="px-3 py-2">Documento</th>
              <th class="px-3 py-2">Nombre</th>
              <th class="px-3 py-2">Apellido</th>
              <th class="px-3 py-2">Teléfono</th>
              <th class="px-3 py-2">Email</th>
              <th class="px-3 py-2">Dirección</th>
              <th class="px-3 py-2">Estado</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="visibles().length === 0">
              <td colspan="8" class="text-center px-3 py-6 text-slate-500">Este cliente no tiene pacientes.</td>
            </tr>
            <tr *ngFor="let p of visibles(); index as i" class="odd:bg-white even:bg-slate-50">
              <td class="px-3 py-2 text-xs text-slate-500">{{ (page()-1)*pageSize() + i + 1 }}</td>
              <td class="px-3 py-2 font-mono">{{ p.documento }}</td>
              <td class="px-3 py-2 font-semibold">{{ p.nombre }}</td>
              <td class="px-3 py-2">{{ p.apellido || '—' }}</td>
              <td class="px-3 py-2">{{ p.telefono || '—' }}</td>
              <td class="px-3 py-2">
                <a *ngIf="p.email" [href]="'mailto:' + p.email" class="text-primary hover:underline">{{ p.email }}</a>
                <span *ngIf="!p.email">—</span>
              </td>
              <td class="px-3 py-2">{{ p.direccion || '—' }}</td>
              <td class="px-3 py-2"><span class="px-2 py-0.5 rounded-full text-[11px] font-medium" [class.bg-green-100]="p.estado==='ACTIVO'" [class.text-green-700]="p.estado==='ACTIVO'" [class.bg-slate-200]="p.estado!=='ACTIVO'" [class.text-slate-600]="p.estado!=='ACTIVO'">{{ p.estado }}</span></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="md:hidden">
        <div *ngIf="visibles().length === 0" class="rounded-lg border border-slate-300 bg-slate-50 text-center text-slate-500 px-4 py-3 text-sm">Este cliente no tiene pacientes.</div>
        <div *ngIf="visibles().length > 0" class="bg-white rounded-2xl shadow-card border border-slate-200/70 overflow-hidden">
          <div *ngFor="let p of visibles()" class="px-3 py-2 border-t first:border-t-0 border-slate-200/70 flex items-center gap-3">
            <div class="w-9 h-9 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center" aria-hidden="true"><i class="bi bi-person"></i></div>
            <div class="min-w-0 flex-1">
              <div class="flex items-center justify-between gap-2">
                <div class="font-medium truncate">{{ p.nombre }} {{ p.apellido || '' }}</div>
                <span class="px-2 py-0.5 rounded-full text-[11px] font-medium shrink-0" [class.bg-green-100]="p.estado==='ACTIVO'" [class.text-green-700]="p.estado==='ACTIVO'" [class.bg-slate-200]="p.estado!=='ACTIVO'" [class.text-slate-600]="p.estado!=='ACTIVO'">{{ p.estado }}</span>
              </div>
              <div class="text-xs text-slate-500 truncate">
                <span *ngIf="p.documento" class="font-mono">{{ p.documento }}</span>
                <span *ngIf="p.telefono" class="mx-1 text-slate-400">•</span> <span *ngIf="p.telefono">Tel: {{ p.telefono }}</span>
                <span *ngIf="p.email" class="mx-1 text-slate-400">•</span> <a *ngIf="p.email" [href]="'mailto:' + p.email" class="text-primary hover:underline break-all">{{ p.email }}</a>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="flex items-center justify-between mt-4">
        <div class="text-xs text-slate-600">Mostrando <strong>{{ visibles().length }}</strong> de <strong>{{ totalPacientes() }}</strong></div>
        <div class="inline-flex rounded-lg shadow-sm overflow-hidden border border-slate-300 bg-white">
          <button class="px-3 py-1.5 text-xs font-medium hover:bg-slate-50 disabled:opacity-50" (click)="prevPage()" [disabled]="page()<=1">Anterior</button>
          <span class="px-3 py-1.5 text-xs border-l border-r border-slate-300 bg-slate-50">Página {{ page() }} / {{ totalPages() }}</span>
          <button class="px-3 py-1.5 text-xs font-medium hover:bg-slate-50 disabled:opacity-50" (click)="nextPage()" [disabled]="page()>=totalPages()">Siguiente</button>
        </div>
      </div>
    </ng-container>
  </ng-container>
  <ng-template #notFound>
    <div class="rounded-lg border border-slate-300 bg-slate-50 text-center text-slate-500 px-4 py-3">No se encontró el cliente.</div>
  </ng-template>
</ng-template>
