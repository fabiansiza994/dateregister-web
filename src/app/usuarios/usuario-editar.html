<div class="max-w-3xl dr-form-pad-bottom">
  <div class="flex items-start justify-between mb-4 gap-3">
    <div>
      <h3 class="text-xl font-semibold m-0">{{ title() }}</h3>
      <p class="text-xs text-slate-500">Edita nombre, apellido y email del usuario</p>
    </div>
    <div class="hidden md:flex gap-2">
      <button type="button" class="btn btn-light" (click)="cancel()"><i class="bi bi-arrow-left"></i> Volver</button>
      <button type="button" class="btn btn-primary" (click)="save()" [disabled]="loading()"><i class="bi bi-check2"></i> Guardar</button>
    </div>
  </div>

  @if (error()) {
  <div class="rounded-lg border border-red-300 bg-red-50 text-red-700 px-4 py-3 text-sm flex gap-3 items-start mb-4" role="alert">
    <i class="bi bi-exclamation-triangle mt-1"></i>
    <div class="font-medium">{{ error() }}</div>
  </div>
  }
  @if (success()) {
  <div class="rounded-lg border border-green-300 bg-green-50 text-green-700 px-4 py-3 text-sm flex gap-3 items-start mb-4" role="alert">
    <i class="bi bi-check-circle mt-1"></i>
    <div class="font-medium">{{ success() }}</div>
  </div>
  }

  <div class="bg-white rounded-2xl shadow-card border border-slate-200/60">
    <form (submit)="$event.preventDefault(); save()">
      <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="form-label">Nombre</label>
          <input class="form-control" type="text" [ngModel]="model().nombre" (ngModelChange)="setModel('nombre', $event)" name="nombre" autocomplete="off">
        </div>
        <div>
          <label class="form-label">Apellido</label>
          <input class="form-control" type="text" [ngModel]="model().apellido" (ngModelChange)="setModel('apellido', $event)" name="apellido" autocomplete="off">
        </div>
        <div class="md:col-span-2">
          <label class="form-label">Email</label>
          <input class="form-control" type="email" [ngModel]="model().email" (ngModelChange)="setModel('email', $event)" name="email" autocomplete="off">
        </div>
        <div>
          <label class="form-label">Grupo</label>
          <select class="form-control" [ngModel]="model().grupoId" (ngModelChange)="setModel('grupoId', $event)" name="grupoId">
            <option [ngValue]="null">— Sin grupo —</option>
            <option *ngFor="let g of grupos()" [ngValue]="g.id">{{ g.nombre }}</option>
          </select>
        </div>
        <div>
          <label class="form-label">Rol</label>
          <select class="form-control" [ngModel]="model().rolId" (ngModelChange)="setModel('rolId', $event)" name="rolId">
            <option [ngValue]="null">— Sin rol —</option>
            <option *ngFor="let r of roles()" [ngValue]="r.id">{{ r.nombre }}</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="form-label">Estado</label>
          <div class="flex items-center gap-3">
            <label class="inline-flex items-center gap-2 cursor-pointer select-none">
              <input type="checkbox" [ngModel]="model().activo" (ngModelChange)="setModel('activo', $event)" name="activo"
                     class="sr-only peer">
              <span class="w-11 h-6 rounded-full bg-slate-300 transition-colors relative peer-focus:outline-none peer-focus-visible:ring-2 peer-focus-visible:ring-offset-2 peer-focus-visible:ring-indigo-500/60
                           peer-checked:bg-green-500">
                <span class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white shadow transition-transform peer-checked:translate-x-5"></span>
              </span>
              <span class="text-sm">Activo</span>
            </label>
            <span class="text-xs text-slate-500">(Si desmarcas, el usuario queda bloqueado)</span>
          </div>
        </div>
        <div class="md:col-span-2">
          <label class="form-label">Nueva contraseña (opcional)</label>
          <input class="form-control" type="text" [ngModel]="newPassword()" (ngModelChange)="newPassword.set($event)" name="newPassword" placeholder="Dejar en blanco para no cambiar">
          <p class="text-xs text-slate-500 mt-1">Si la completas, se actualizará al guardar cambios.</p>
        </div>
      </div>
      <div class="border-t border-slate-200/70 p-4 flex justify-end gap-2">
        <button type="button" class="btn btn-outline-secondary" (click)="cancel()">Cancelar</button>
        <button type="submit" class="btn btn-primary" [disabled]="loading()">
          @if (loading()) { <span class="spinner-border spinner-border-sm mr-2"></span> }
          Guardar cambios
        </button>
      </div>
    </form>
  </div>

  <!-- Mobile FAB actions -->
  <div class="md:hidden dr-form-fab">
    <div class="dr-fab-inner">
      <button type="button" class="btn btn-outline-secondary" (click)="cancel()">Cancelar</button>
      <button type="button" class="btn btn-primary" (click)="save()" [disabled]="loading()">
        @if (loading()) { <span class="spinner-border spinner-border-sm mr-1"></span> }
        Guardar
      </button>
    </div>
  </div>
</div>

<!-- Cancel confirm modal -->
@if (cancelConfirmOpen()) {
  <div class="fixed inset-0 z-[60] flex items-center justify-center">
    <div class="fixed inset-0 bg-black/40 z-[55]" (click)="closeCancelConfirm()"></div>
    <div class="relative w-full max-w-md mx-auto z-[65]">
      <div class="bg-white rounded-2xl shadow-card p-5 border border-slate-200/70">
        <div class="flex items-start justify-between mb-3">
          <h5 class="font-semibold flex items-center gap-2 text-amber-600"><i class="bi bi-exclamation-triangle"></i><span>Descartar cambios</span></h5>
          <button type="button" (click)="closeCancelConfirm()" class="btn btn-close"></button>
        </div>
        <div class="space-y-2 text-sm">
          <p class="m-0">Tienes cambios sin guardar. ¿Deseas salir y descartarlos?</p>
        </div>
        <div class="flex justify-end gap-2 mt-5">
          <button type="button" (click)="closeCancelConfirm()" [disabled]="loading()" class="btn btn-outline-secondary">Seguir editando</button>
          <button type="button" (click)="proceedCancel()" [disabled]="loading()" class="btn btn-danger">Descartar</button>
        </div>
      </div>
    </div>
  </div>
}
