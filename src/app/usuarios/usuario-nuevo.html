<div class="max-w-5xl mx-auto py-6 px-4 dr-form-pad-bottom">
  <div class="flex flex-wrap items-start justify-between gap-4 mb-6">
    <h3 class="m-0 text-2xl font-semibold leading-tight">Crear usuario<br/><span class="mt-1 block text-xs font-medium text-slate-500">Estos usuarios son los colaboradores que gestionarán trabajos en tu empresa</span></h3>
    <div class="hidden md:block">
      <button type="button" (click)="cancel()" class="inline-flex items-center gap-2 text-primary hover:underline text-sm font-medium">&larr; Volver</button>
    </div>

  <!-- Progreso -->
  <div class="mb-6">
    <div class="flex items-center justify-between text-[11px] font-semibold tracking-wide mb-2">
      <span [class.text-primary]="step===1" [class.text-slate-400]="step!==1">1. Datos personales</span>
      <span [class.text-primary]="step===2" [class.text-slate-400]="step!==2">2. Grupo</span>
    </div>
    <div class="h-2 w-full rounded-full bg-slate-200 overflow-hidden">
      <div class="h-full bg-gradient-to-r from-primary to-primary/70 transition-all" [style.width.%]="step===1?50:100"></div>
    </div>
  </div>

  <!-- Mensajes -->
  @if (error()) {
    <div class="rounded-lg border border-red-300 bg-red-50 text-red-700 px-4 py-3 text-sm flex gap-3 items-start mb-4" role="alert">
      <span class="font-bold mt-0.5">⚠️</span>
      <div class="font-medium">{{ error() }}</div>
    </div>
  }
  @if (success()) {
    <div class="rounded-lg border border-green-300 bg-green-50 text-green-700 px-4 py-3 text-sm flex gap-3 items-start mb-4" role="alert">
      <span class="font-bold mt-0.5">✅</span>
      <div class="font-medium">{{ success() }}</div>
    </div>
  }

  <div class="bg-white shadow-card rounded-2xl border border-slate-200/70">
    <div class="p-6">

      <!-- STEP 1 -->
      @if (step === 1) {
        <form (submit)="$event.preventDefault(); goToStep(2)">
          <h5 class="text-lg font-semibold mb-4">1) Datos personales</h5>
          <div class="grid gap-5 md:grid-cols-2">
            <div>
              <label class="text-sm font-medium text-slate-700 mb-1">Nombre *</label>
              <input type="text" class="form-control"
                     [class.is-invalid]="fieldErrors()['nombre']"
                     [ngModel]="model().nombre"
                     (ngModelChange)="onField('nombre', $event); updateSuggestedUser()"
                     name="nombre"
                     placeholder="Juan" autocomplete="off" />
              @if (fieldErrors()['nombre']) {
                <div class="invalid-feedback">{{ fieldErrors()['nombre'] }}</div>
              }
            </div>
            <div>
              <label class="text-sm font-medium text-slate-700 mb-1">Apellido *</label>
              <input type="text" class="form-control"
                     [class.is-invalid]="fieldErrors()['apellido']"
                     [ngModel]="model().apellido"
                     (ngModelChange)="onField('apellido', $event); updateSuggestedUser()"
                     name="apellido"
                     placeholder="Pérez" autocomplete="off" />
              @if (fieldErrors()['apellido']) {
                <div class="invalid-feedback">{{ fieldErrors()['apellido'] }}</div>
              }
            </div>
            <div>
              <label class="text-sm font-medium text-slate-700 mb-1">Usuario *</label>
              <div class="flex">
                <input type="text" class="form-control"
                       [class.is-invalid]="fieldErrors()['usuario'] || invalidUsername()"
                       [ngModel]="model().usuario"
                       (ngModelChange)="onField('usuario', $event); onUsuarioInput()"
                       name="usuario"
                       placeholder="juana_38543" autocomplete="off" readonly/>
                <button class="btn btn-outline-secondary ml-2" type="button" (click)="rollUsername()" title="Generar usuario aleatorio">
                  <i class="bi bi-dice-5"></i>
                </button>
              </div>
              @if (fieldErrors()['usuario']) {
                <div class="invalid-feedback">{{ fieldErrors()['usuario'] }}</div>
              }
              @if (!fieldErrors()['usuario'] && invalidUsername()) {
                <div class="text-amber-600 text-xs mt-1">Formato: letras/números y terminar con _ + 1–5 dígitos (p. ej. juana_38543 o juana.perez_123).</div>
              }
              <p class="text-xs text-slate-500 mt-1">Usa el botón del dado para generar: nombre_ + un número aleatorio (máx. 5 dígitos).</p>
            </div>
            <div>
              <label class="text-sm font-medium text-slate-700 mb-1">Email (generado automáticamente)</label>
              <input type="email" class="form-control"
                     [class.is-invalid]="fieldErrors()['email']"
                     [ngModel]="model().email"
                     [ngModelOptions]="{standalone: true}"
                     name="email"
                     placeholder="juana_@38543.com" autocomplete="off" readonly/>
              @if (fieldErrors()['email']) {
                <div class="invalid-feedback">{{ fieldErrors()['email'] }}</div>
              }
              <p class="text-xs text-slate-500 mt-1">Se genera con el primer nombre y un número aleatorio (p. ej. juana_@38543.com).</p>
            </div>
            <div>
              <label class="text-sm font-medium text-slate-700 mb-1">Contraseña *</label>
              <input type="password" class="form-control"
                     [class.is-invalid]="fieldErrors()['password']"
                     [ngModel]="model().password" (ngModelChange)="onField('password', $event)" name="password"
                     placeholder="••••••••" autocomplete="off" />
              @if (fieldErrors()['password']) {
                <div class="invalid-feedback">{{ fieldErrors()['password'] }}</div>
              }
            </div>
            <div>
              <label class="text-sm font-medium text-slate-700 mb-1">Confirmar contraseña *</label>
              <input type="password" class="form-control"
                     [class.is-invalid]="passwordMismatch()"
                     [ngModel]="confirmPassword()" (ngModelChange)="onConfirmPassword($event)" name="passwordConfirm"
                     placeholder="••••••••" autocomplete="off" />
              @if (passwordMismatch()) {
                <div class="invalid-feedback">Las contraseñas no coinciden.</div>
              }
            </div>
          </div>
          <div class="hidden md:flex justify-end gap-3 mt-6">
            <button class="btn btn-primary" type="submit" [disabled]="!isStep1Valid()">Siguiente</button>
          </div>
        </form>
      }

      <!-- STEP 2 -->
      @if (step === 2) {
        <form (submit)="$event.preventDefault(); submit()">
          <h5 class="text-lg font-semibold mb-4">2) Grupo</h5>

          <div class="grid gap-5 md:grid-cols-12 items-end">
            <div class="md:col-span-8 space-y-1">
              <label class="text-sm font-medium text-slate-700">Buscar grupos</label>
              <div class="flex">
                <input type="text" class="form-control"
                       [(ngModel)]="qGroup" name="qGroup" (keyup.enter)="loadGrupos()"
                       placeholder="Nombre del grupo" autocomplete="off">
                <button type="button" class="btn btn-outline-secondary ml-2" (click)="loadGrupos()"><i class="bi bi-search"></i></button>
              </div>
              @if (errorGrupos()) {
                <div class="text-red-600 text-xs mt-1">{{ errorGrupos() }}</div>
              } @else {
                @if (totalGrupos() > 0) {
                  <div class="text-xs text-slate-500">{{ totalGrupos() }} grupo(s) encontrados</div>
                }
              }
            </div>
            <div class="md:col-span-4 space-y-1">
              <label class="text-sm font-medium text-slate-700">Seleccionar grupo *</label>
              <select class="form-select"
                      [class.is-invalid]="fieldErrors()['grupo.id']"
                      [ngModel]="model().grupo.id" (ngModelChange)="onGrupoChange($event)" name="grupoId"
                      [disabled]="loadingGrupos()">
                <option [ngValue]="null" disabled>— Selecciona —</option>
                <option *ngFor="let g of grupos()" [ngValue]="g.id">{{ g.nombre }}</option>
              </select>
              @if (fieldErrors()['grupo.id']) {
                <div class="invalid-feedback">{{ fieldErrors()['grupo.id'] }}</div>
              }
            </div>
          </div>

          <!-- Resumen -->
          <div class="mt-6">
            <h6 class="text-sm font-bold mb-3">Resumen</h6>
            <ul class="divide-y divide-slate-200 text-xs rounded-xl border border-slate-200 bg-white overflow-hidden">
              <li class="px-4 py-2"><strong>Usuario:</strong> {{ model().usuario }} — {{ model().nombre }} {{ model().apellido }}</li>
              <li class="px-4 py-2"><strong>Email:</strong> {{ model().email }}</li>
              <li class="px-4 py-2"><strong>Empresa ID:</strong> {{ model().empresa.id }}</li>
              <li class="px-4 py-2"><strong>Grupo ID:</strong> {{ model().grupo.id ?? '—' }}</li>
              <li class="px-4 py-2"><strong>Rol:</strong> USER (id: 2)</li>
            </ul>
          </div>

          <div class="hidden md:flex justify-between gap-3 mt-6">
            <button class="btn btn-outline-secondary" type="button" (click)="goToStep(1)" [disabled]="loading()">Atrás</button>
            <button class="btn btn-primary" type="submit" [disabled]="!isStep2Valid() || loading()">
              @if (loading()) { <span class="spinner-border spinner-border-sm mr-2" role="status"></span> }
              Crear usuario
            </button>
          </div>
        </form>
      }

    </div>
  </div>

    <!-- Mobile FAB actions -->
    <div class="md:hidden dr-form-fab">
      <div class="dr-fab-inner">
        @if (step === 1) {
          <button type="button" class="btn btn-outline-secondary" (click)="cancel()">Cancelar</button>
          <button type="button" class="btn btn-primary" (click)="goToStep(2)" [disabled]="!isStep1Valid()">Siguiente</button>
        }
        @if (step === 2) {
          <button type="button" class="btn btn-outline-secondary" (click)="goToStep(1)" [disabled]="loading()">Atrás</button>
          <button type="button" class="btn btn-primary" (click)="submit()" [disabled]="!isStep2Valid() || loading()">
            @if (loading()) { <span class="spinner-border spinner-border-sm mr-1"></span> }
            Crear
          </button>
        }
      </div>
    </div>
  </div>

  <!-- Cancel confirm modal -->
  @if (cancelConfirmOpen()) {
    <div class="fixed inset-0 z-[60] flex items-center justify-center">
      <div class="fixed inset-0 bg-black/40 z-[55]" (click)="closeCancelConfirm()"></div>
      <div class="relative w-full max-w-md mx-auto z-[65]">
        <div class="bg-white rounded-2xl shadow-card p-5 border border-slate-200/70">
          <div class="flex items-start justify-between mb-3">
            <h5 class="font-semibold flex items-center gap-2 text-amber-600"><i class="bi bi-exclamation-triangle"></i><span>Descartar cambios</span></h5>
            <button type="button" (click)="closeCancelConfirm()" class="btn btn-close"></button>
          </div>
          <div class="space-y-2 text-sm">
            <p class="m-0">Tienes cambios sin guardar. ¿Deseas salir y descartarlos?</p>
          </div>
          <div class="flex justify-end gap-2 mt-5">
            <button type="button" (click)="closeCancelConfirm()" [disabled]="loading()" class="btn btn-outline-secondary">Seguir editando</button>
            <button type="button" (click)="proceedCancel()" [disabled]="loading()" class="btn btn-danger">Descartar</button>
          </div>
        </div>
      </div>
    </div>
  }
</div>
