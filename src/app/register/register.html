<div class="container py-4">
  <!-- Encabezado -->
  <div class="text-center mb-4">
    <h2 class="fw-bold">Crear cuenta</h2>
    <p class="text-secondary mb-0">Completa los pasos y estar√°s listo para usar DataRegister</p>
  </div>

  <!-- Progreso -->
  <div class="mb-4">
    <div class="d-flex justify-content-between small fw-semibold mb-1">
      <span [class.text-primary]="step===1">1. Datos personales</span>
      <span [class.text-primary]="step===2">2. Empresa</span>
      <span [class.text-primary]="step===3">3. Grupo & Confirmaci√≥n</span>
    </div>
    <div class="progress" style="height: 8px;">
      <div class="progress-bar" role="progressbar" [style.width.%]="step===1 ? 33 : step===2 ? 66 : 100"
        aria-valuemin="0" aria-valuemax="100"></div>
    </div>
  </div>

  <!-- Mensajes globales -->
  @if (error()) {
  <div class="alert alert-danger d-flex align-items-start gap-2" role="alert">
    <span class="fw-bold mt-1">‚ö†Ô∏è</span>
    <div>{{ error() }}</div>
  </div>
  }
  @if (successMessage()) {
  <div class="alert alert-success d-flex align-items-start gap-2" role="alert">
    <span class="fw-bold mt-1">‚úÖ</span>
    <div>{{ successMessage() }}</div>
  </div>
  }

  <!-- CARD -->
  <div class="card shadow-sm border-0 rounded-4">
    <div class="card-body p-4">

      <!-- PASO 1: Datos personales -->
      @if (step === 1) {
      <div>
        <h4 class="fw-semibold mb-3">1) Datos personales</h4>
        <p class="text-secondary small mb-4">
          ¬°Est√°s a un paso de comenzar! üí™ Completa tus datos para personalizar tu experiencia.
        </p>

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Usuario</label>
            <input style="border-style: dashed;" type="text" class="form-control" placeholder="nick01" [(ngModel)]="model.usuario"
              (ngModelChange)="onUsuarioInput()" readonly="true">
            <div class="form-text">
              Sugerido autom√°ticamente a partir de tu nombre y apellido.
            </div>

            @if(invalidUsername){
            <div class="text-warning small mt-1">
              El usuario solo debe contener letras, n√∫meros y puntos.
            </div>
            }
          </div>

          <div class="col-md-6">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" placeholder="usuario@gmail.com" [(ngModel)]="model.email">
          </div>

          <div class="col-md-6">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-control" placeholder="Usuario" [(ngModel)]="model.nombre"
              (ngModelChange)="updateSuggestedUser()">
          </div>

          <div class="col-md-6">
            <label class="form-label">Apellido</label>
            <input type="text" class="form-control" placeholder="Apellido" [(ngModel)]="model.apellido"
              (ngModelChange)="updateSuggestedUser()">
          </div>

          <div class="col-md-6">
            <label class="form-label">Contrase√±a</label>
            <input type="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" [(ngModel)]="model.password">
          </div>

          <div class="col-md-6">
            <label class="form-label">Confirmar contrase√±a</label>
            <input type="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" [(ngModel)]="confirmPassword">
            @if(model.password && confirmPassword && !passwordsMatch){
            <div class="text-danger small mt-1">Las contrase√±as no coinciden.</div>
            }
          </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-4">
          <button class="btn btn-light" (click)="volver()">
            Cancelar
          </button>
          <button class="btn btn-primary" [disabled]="!isStep1Valid() || loading()" (click)="goToStep(2)">
            Siguiente
          </button>
        </div>

        @if(isStep1Valid()) {
        <div class="alert alert-success mt-3 py-2 small" role="alert">
          üéâ ¬°Primer logro desbloqueado! Tus datos se ven geniales.
        </div>
        }
      </div>
      }

      <!-- PASO 2: Empresa -->
      @if (step === 2) {
      <div>
        <h4 class="fw-semibold mb-3">2) Empresa</h4>
        <p class="text-secondary small mb-4">
          ¬°Excelente ritmo! üöÄ Dinos sobre tu empresa para configurar tu espacio de trabajo.
        </p>

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nombre de la empresa</label>
            <input type="text" class="form-control" placeholder="LuthorCorp" [(ngModel)]="model.empresa.nombre">
          </div>
          <div class="col-md-6">
            <label class="form-label">NIT</label>
            <input type="text" class="form-control" placeholder="000-1" [(ngModel)]="model.empresa.nit">
          </div>

          <!-- Pa√≠s -->
          <div class="col-md-6">
            <label class="form-label">Pa√≠s</label>

            @if (loadingPaises()) {
            <div class="form-text">Cargando pa√≠ses‚Ä¶</div>
            }

            @if (errorPaises()) {
            <div class="alert alert-warning py-2 small mt-1" role="alert">
              {{ errorPaises() }}
            </div>
            }

            <select class="form-select" [(ngModel)]="model.empresa.pais.id"
              [disabled]="loadingPaises() || !!errorPaises()">
              <option [ngValue]="null" disabled>Selecciona un pa√≠s</option>
              <option *ngFor="let p of paises" [ngValue]="p.id">
                {{ p.nombre }} ({{ p.codigoPais }})
              </option>
            </select>
          </div>

          <!-- Sector -->
          <div class="col-md-6">
            <label class="form-label">Sector</label>

            @if (loadingSectores()) {
            <div class="form-text">Cargando sectores‚Ä¶</div>
            }

            @if (errorSectores()) {
            <div class="alert alert-warning py-2 small mt-1" role="alert">
              {{ errorSectores() }}
            </div>
            }

            <select class="form-select" [(ngModel)]="model.empresa.sector.id"
              [disabled]="loadingSectores() || !!errorSectores()">
              <option [ngValue]="null" disabled>Selecciona un sector</option>
              <option *ngFor="let s of sectores" [ngValue]="s.id">
                {{ s.nombre }}
              </option>
            </select>
          </div>
        </div>

        <div class="d-flex justify-content-between gap-2 mt-4">
          <button class="btn btn-outline-secondary" (click)="goToStep(1)" [disabled]="loading()">Atr√°s</button>
          <button class="btn btn-primary" (click)="goToStep(3)"
            [disabled]="!isStep2Valid() || loading()">Siguiente</button>
        </div>

        @if(isStep2Valid()) {
        <div class="alert alert-success mt-3 py-2 small" role="alert">
          üèÖ ¬°Segundo logro conseguido! Tu empresa est√° lista para brillar.
        </div>
        }
      </div>
      }

      <!-- PASO 3: Grupo & Confirmaci√≥n -->
      @if (step === 3) {
      <div>
        <h4 class="fw-semibold mb-3">3) Grupo & Confirmaci√≥n</h4>
        <p class="text-secondary small mb-4">
          ¬°√öltimo empuj√≥n! üåü Crea tu grupo y confirma que todo est√© correcto.
        </p>

        <div class="row g-3">
          <div class="col-md-8">
            <label class="form-label">Nombre del grupo</label>
            <input type="text" class="form-control" placeholder="administradores del sistema"
              [(ngModel)]="model.grupo.nombre">
          </div>
        </div>

        <!-- Resumen -->
        <div class="mt-4">
          <h6 class="fw-bold mb-2">Resumen</h6>
          <ul class="list-group small">
            <li class="list-group-item">
              <strong>Usuario:</strong> {{ model.usuario }} ‚Äî {{ model.nombre }} {{ model.apellido }}
            </li>
            <li class="list-group-item">
              <strong>Email:</strong> {{ model.email }}
            </li>
            <li class="list-group-item">
              <strong>Empresa:</strong> {{ model.empresa?.nombre }} (NIT: {{ model.empresa?.nit }})
            </li>
            <li class="list-group-item">
              <strong>Pa√≠s:</strong> {{ viewPais(model.empresa.pais?.id ?? null) }} ‚Äî
              <strong>Sector:</strong> {{ viewSector(model.empresa.sector?.id ?? null) }}
            </li>
            <li class="list-group-item">
              <strong>Grupo:</strong> {{ model.grupo.nombre }}
            </li>
          </ul>
        </div>

        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" id="terms" [(ngModel)]="acceptedTerms">
          <label class="form-check-label small" for="terms">
            Acepto los t√©rminos y condiciones y la pol√≠tica de privacidad.
          </label>
        </div>

        <div class="d-flex justify-content-between gap-2 mt-4">
          <button class="btn btn-outline-secondary" (click)="goToStep(2)" [disabled]="loading()">Atr√°s</button>
          <button class="btn btn-success" [disabled]="!isStep3Valid() || loading()" (click)="submit()">
            @if(loading()) {
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            }
            Crear cuenta
          </button>
        </div>

        @if(isStep3Valid()) {
        <div class="alert alert-success mt-3 py-2 small" role="alert">
          ü•≥ ¬°Lo lograste! Tu cuenta est√° lista para ser creada.
        </div>
        }
      </div>
      }

    </div>
  </div>
</div>