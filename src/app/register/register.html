<div class="max-w-5xl mx-auto px-4 py-6">
  <!-- Encabezado -->
  <div class="text-center mb-6">
    <h2 class="text-2xl font-bold text-gray-900">Crear cuenta</h2>
    <p class="text-gray-600">Completa los pasos y estar√°s listo para usar DataRegister</p>
  </div>

  <!-- Progreso -->
  <div class="mb-6">
    <div class="flex justify-between text-xs font-semibold text-gray-600 mb-2">
      <span [class.text-primary-600]="step===1">1. Datos personales</span>
      <span [class.text-primary-600]="step===2">2. Empresa</span>
      <span [class.text-primary-600]="step===3">3. Grupo & Confirmaci√≥n</span>
    </div>
    <div class="h-2 w-full bg-gray-200 rounded-full overflow-hidden">
      <div class="h-full bg-primary-600 transition-all" [style.width.%]="step===1 ? 33 : step===2 ? 66 : 100"></div>
    </div>
  </div>

  <!-- Mensajes globales -->
  @if (error()) {
  <div class="mb-4 p-3 rounded-lg border-l-4 border-red-500 bg-red-50 text-red-700 flex gap-2" role="alert">
    <span class="font-bold mt-0.5">‚ö†Ô∏è</span>
    <div>{{ error() }}</div>
  </div>
  }
  @if (successMessage()) {
  <div class="mb-4 p-3 rounded-lg border-l-4 border-green-500 bg-green-50 text-green-700 flex gap-2" role="alert">
    <span class="font-bold mt-0.5">‚úÖ</span>
    <div>{{ successMessage() }}</div>
  </div>
  }

  <!-- CARD -->
  <div class="bg-white shadow-sm rounded-xl border border-gray-200">
    <div class="p-5">

      <!-- PASO 1: Datos personales -->
      @if (step === 1) {
      <div>
        <h4 class="text-lg font-semibold text-gray-900 mb-2">1) Datos personales</h4>
        <p class="text-gray-600 text-sm mb-4">
          ¬°Est√°s a un paso de comenzar! üí™ Completa tus datos para personalizar tu experiencia.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Usuario</label>
            <input type="text" class="mt-1 block w-full rounded-md border border-dashed border-gray-300 px-3 py-2 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm bg-gray-50"
              placeholder="nick01" [(ngModel)]="model.usuario" (ngModelChange)="onUsuarioInput()" readonly>
            <div class="text-gray-500 text-xs mt-1">
              Sugerido autom√°ticamente a partir de tu nombre y apellido.
            </div>

            @if(invalidUsername){
            <div class="text-amber-600 text-xs mt-1">
              El usuario solo debe contener letras, n√∫meros y puntos.
            </div>
            }
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              placeholder="usuario@gmail.com" [(ngModel)]="model.email">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Nombre</label>
            <input type="text" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              placeholder="Usuario" [(ngModel)]="model.nombre" (ngModelChange)="updateSuggestedUser()">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Apellido</label>
            <input type="text" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              placeholder="Apellido" [(ngModel)]="model.apellido" (ngModelChange)="updateSuggestedUser()">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Contrase√±a</label>
            <input type="password" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" [(ngModel)]="model.password">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Confirmar contrase√±a</label>
            <input type="password" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" [(ngModel)]="confirmPassword">
            @if(model.password && confirmPassword && !passwordsMatch){
            <div class="text-red-600 text-xs mt-1">Las contrase√±as no coinciden.</div>
            }
          </div>
        </div>

        <div class="flex justify-end gap-2 mt-5">
          <button class="px-4 py-2 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50" (click)="volver()">
            Cancelar
          </button>
          <button class="px-4 py-2 rounded-md bg-primary-600 text-white hover:bg-primary-700 disabled:opacity-50" [disabled]="!isStep1Valid() || loading()" (click)="goToStep(2)">
            Siguiente
          </button>
        </div>

        @if(isStep1Valid()) {
        <div class="mt-3 p-2 text-sm rounded-md border-l-4 border-green-500 bg-green-50 text-green-700" role="alert">
          üéâ ¬°Primer logro desbloqueado! Tus datos se ven geniales.
        </div>
        }
      </div>
      }

      <!-- PASO 2: Empresa -->
      @if (step === 2) {
      <div>
        <h4 class="text-lg font-semibold text-gray-900 mb-2">2) Empresa</h4>
        <p class="text-gray-600 text-sm mb-4">
          ¬°Excelente ritmo! üöÄ Dinos sobre tu empresa para configurar tu espacio de trabajo.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Nombre de la empresa</label>
            <input type="text" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              placeholder="LuthorCorp" [(ngModel)]="model.empresa.nombre">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">NIT</label>
            <input type="text" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              placeholder="000-1" [(ngModel)]="model.empresa.nit">
          </div>

          <!-- Pa√≠s -->
          <div>
            <label class="block text-sm font-medium text-gray-700">Pa√≠s</label>

            @if (loadingPaises()) {
            <div class="text-xs text-gray-500">Cargando pa√≠ses‚Ä¶</div>
            }

            @if (errorPaises()) {
            <div class="mt-1 p-2 text-xs rounded-md border-l-4 border-amber-500 bg-amber-50 text-amber-800" role="alert">
              {{ errorPaises() }}
            </div>
            }

            <select class="mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              [(ngModel)]="model.empresa.pais.id" [disabled]="loadingPaises() || !!errorPaises()">
              <option [ngValue]="null" disabled>Selecciona un pa√≠s</option>
              <option *ngFor="let p of paises" [ngValue]="p.id">
                {{ p.nombre }} ({{ p.codigoPais }})
              </option>
            </select>
          </div>

          <!-- Sector -->
          <div>
            <label class="block text-sm font-medium text-gray-700">Sector</label>

            @if (loadingSectores()) {
            <div class="text-xs text-gray-500">Cargando sectores‚Ä¶</div>
            }

            @if (errorSectores()) {
            <div class="mt-1 p-2 text-xs rounded-md border-l-4 border-amber-500 bg-amber-50 text-amber-800" role="alert">
              {{ errorSectores() }}
            </div>
            }

            <select class="mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              [(ngModel)]="model.empresa.sector.id" [disabled]="loadingSectores() || !!errorSectores()">
              <option [ngValue]="null" disabled>Selecciona un sector</option>
              <option *ngFor="let s of sectores" [ngValue]="s.id">
                {{ s.nombre }}
              </option>
            </select>

            <!-- Mensaje contextual seg√∫n el sector -->
            <div class="mt-2">
              @if (sectorNombreSel === 'SALUD') {
              <div class="p-2 text-xs rounded-md border-l-4 border-blue-500 bg-blue-50 text-blue-800">
                Elegiste <strong>SALUD</strong>: adem√°s del registro de trabajos y clientes, tendr√°s el m√≥dulo de
                <strong>pacientes</strong> para gestionar historiales y atenciones.
              </div>
              } @else if (sectorNombreSel === 'GENERAL') {
              <div class="p-2 text-xs rounded-md border-l-4 border-gray-400 bg-gray-50 text-gray-700">
                Elegiste <strong>GENERAL</strong>: gestiona tus trabajos de forma profesional, registra
                <strong>trabajos, clientes y reportes</strong>.
              </div>
              }
            </div>
          </div>
        </div>

        <div class="flex justify-between gap-2 mt-5">
          <button class="px-4 py-2 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50" (click)="goToStep(1)" [disabled]="loading()">Atr√°s</button>
          <button class="px-4 py-2 rounded-md bg-primary-600 text-white hover:bg-primary-700 disabled:opacity-50" (click)="goToStep(3)" [disabled]="!isStep2Valid() || loading()">Siguiente</button>
        </div>

        @if(isStep2Valid()) {
        <div class="mt-3 p-2 text-sm rounded-md border-l-4 border-green-500 bg-green-50 text-green-700" role="alert">
          üèÖ ¬°Segundo logro conseguido! Tu empresa est√° lista para brillar.
        </div>
        }
      </div>
      }

      <!-- PASO 3: Grupo & Confirmaci√≥n -->
      @if (step === 3) {
      <div>
        <h4 class="text-lg font-semibold text-gray-900 mb-2">3) Grupo & Confirmaci√≥n</h4>
        <p class="text-gray-600 text-sm mb-4">
          ¬°√öltimo empuj√≥n! üåü Crea tu grupo y confirma que todo est√© correcto.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="md:col-span-2 md:max-w-xl">
            <label class="block text-sm font-medium text-gray-700">Nombre del grupo</label>
            <input type="text" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              placeholder="administradores del sistema" [(ngModel)]="model.grupo.nombre">
          </div>
        </div>

        <!-- Resumen -->
        <div class="mt-5">
          <h6 class="text-sm font-bold text-gray-900 mb-2">Resumen</h6>
          <ul class="text-sm rounded-md border border-gray-200 divide-y divide-gray-200">
            <li class="px-3 py-2">
              <strong>Usuario:</strong> {{ model.usuario }} ‚Äî {{ model.nombre }} {{ model.apellido }}
            </li>
            <li class="px-3 py-2">
              <strong>Email:</strong> {{ model.email }}
            </li>
            <li class="px-3 py-2">
              <strong>Empresa:</strong> {{ model.empresa.nombre }} (NIT: {{ model.empresa.nit }})
            </li>
            <li class="px-3 py-2">
              <strong>Pa√≠s:</strong> {{ viewPais(model.empresa.pais.id) }} ‚Äî
              <strong>Sector:</strong> {{ viewSector(model.empresa.sector.id) }}
            </li>
            <li class="px-3 py-2">
              <strong>Grupo:</strong> {{ model.grupo.nombre }}
            </li>
          </ul>
        </div>

        <div class="mt-3 flex items-start gap-2">
          <input id="terms" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500" [(ngModel)]="acceptedTerms">
          <label class="text-xs text-gray-700" for="terms">
            Acepto los t√©rminos y condiciones y la pol√≠tica de privacidad.
          </label>
        </div>

        <div class="flex justify-between gap-2 mt-5">
          <button class="px-4 py-2 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50" (click)="goToStep(2)" [disabled]="loading()">Atr√°s</button>
          <button class="px-4 py-2 rounded-md bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 flex items-center gap-2" [disabled]="!isStep3Valid() || loading()" (click)="submit()">
            @if(loading()) {
            <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            }
            Crear cuenta
          </button>
        </div>

        @if(isStep3Valid()) {
        <div class="mt-3 p-2 text-sm rounded-md border-l-4 border-green-500 bg-green-50 text-green-700" role="alert">
          ü•≥ ¬°Lo lograste! Tu cuenta est√° lista para ser creada.
        </div>
        }
      </div>
      }

    </div>
  </div>
</div>