<div class="container py-3">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="fw-semibold mb-0">Crear trabajo</h3>
    <a routerLink="/trabajos" class="btn btn-link text-decoration-none px-0">&larr; Volver</a>
  </div>

  <!-- Error global -->
  @if (error()) {
    <div class="alert alert-danger d-flex align-items-start gap-2" role="alert">
      <i class="bi bi-exclamation-triangle mt-1"></i>
      <div>{{ error() }}</div>
      <button type="button" class="btn-close ms-auto" (click)="error.set(null)"></button>
    </div>
  }

  <!-- Form -->
  <form class="card border-0 shadow-sm rounded-4" (submit)="$event.preventDefault(); create()">
    <div class="card-body">
      <div class="row g-3">

        <div class="col-md-3">
          <label class="form-label">Fecha <span class="text-danger">*</span></label>
          <input type="date" class="form-control" [(ngModel)]="form.fecha" name="fecha" required>
        </div>

        <!-- Cliente/Paciente según sector -->
        @if (sector() !== 'SALUD') {
          <div class="col-md-5">
            <label class="form-label d-flex align-items-center justify-content-between">
              <span>Cliente <span class="text-danger">*</span></span>
              @if (selectedClient) {
                <small class="text-secondary">ID: {{ selectedClient?.id }}</small>
              }
            </label>

            <div class="input-group">
              <input type="text" class="form-control"
                     [value]="selectedClient ? (selectedClient.nombre + ' ' + (selectedClient.apellido||'')) : ''"
                     placeholder="Sin seleccionar" readonly>
              <button type="button" class="btn btn-outline-primary" (click)="openClientModal()">
                <i class="bi bi-search"></i> Seleccionar
              </button>
              <button type="button" class="btn btn-outline-secondary" (click)="clearClient()" [disabled]="!selectedClient">
                Limpiar
              </button>
            </div>

            @if (!selectedClient) {
              <div class="form-text">Debes seleccionar o crear un cliente.</div>
            }
          </div>
        } @else {
          <div class="col-md-5">
            <label class="form-label d-flex align-items-center justify-content-between">
              <span>Paciente <span class="text-danger">*</span></span>
              @if (selectedPatient) {
                <small class="text-secondary">ID: {{ selectedPatient?.id }}</small>
              }
            </label>

            <div class="input-group">
              <input type="text" class="form-control"
                     [value]="selectedPatient ? (selectedPatient.nombre + ' ' + (selectedPatient.apellido||'')) : ''"
                     placeholder="Sin seleccionar" readonly>
              <button type="button" class="btn btn-outline-success" (click)="openPatientModal()">
                <i class="bi bi-heart-pulse"></i> Seleccionar
              </button>
              <button type="button" class="btn btn-outline-secondary" (click)="clearPatient()" [disabled]="!selectedPatient">
                Limpiar
              </button>
            </div>

            @if (!selectedPatient) {
              <div class="form-text">Debes seleccionar o crear un paciente.</div>
            }
          </div>
        }

        <!-- Forma de pago -->
        <div class="col-md-4">
          <label class="form-label">Forma de pago <span class="text-danger">*</span></label>
          <select class="form-select" [(ngModel)]="form.formaPagoId" name="formaPagoId" required>
            <option [ngValue]="0" disabled>Seleccione…</option>
            <option *ngFor="let f of formasPago" [ngValue]="f.id">{{ f.formaPago }}</option>
          </select>
          @if (mopLoading()) {
            <div class="small text-secondary">Cargando formas de pago…</div>
          }
        </div>

        <!-- Valores -->
        <div class="col-md-3">
          <label class="form-label">Valor mano de obra</label>
          <input type="number" class="form-control"
                 [(ngModel)]="form.valorLabor" name="valorLabor"
                 min="0" step="1"
                 (ngModelChange)="recalc()">
        </div>

        <div class="col-md-3">
          <label class="form-label">Valor materiales</label>
          <input type="number" class="form-control"
                 [(ngModel)]="form.valorMateriales" name="valorMateriales"
                 min="0" step="1"
                 (ngModelChange)="recalc()">
        </div>

        <div class="col-md-3">
          <label class="form-label">Valor total (auto)</label>
          <input type="number" class="form-control"
                 [value]="totalCalc()" readonly>
          <div class="form-text">Se calcula: mano de obra + materiales.</div>
        </div>

        <div class="col-md-3">
          <label class="form-label">Ganancias (auto)</label>
          <input type="number" class="form-control"
                 [value]="gananciasCalc()" readonly>
          <div class="form-text">Se calcula: total − materiales.</div>
        </div>

        <div class="col-12">
          <label class="form-label">Descripción de la labor <span class="text-danger">*</span></label>
          <textarea class="form-control" rows="3"
                    [(ngModel)]="form.descripcionLabor" name="descripcionLabor"
                    required maxlength="500"></textarea>
          <div class="form-text">{{ (form.descripcionLabor?.length || 0) }}/500</div>
        </div>

        <!-- Imágenes -->
        <div class="col-md-6">
          <label class="form-label">Foto 1</label>
          <input type="file" class="form-control" accept="image/*" (change)="onFileChange($event, 'foto1')">
          @if (previews.foto1) {
            <div class="mt-2">
              <img [src]="previews.foto1" alt="foto1" class="img-thumbnail" style="max-width: 220px; object-fit: cover;">
            </div>
          }
        </div>

        <div class="col-md-6">
          <label class="form-label">Foto 2</label>
          <input type="file" class="form-control" accept="image/*" (change)="onFileChange($event, 'foto2')">
          @if (previews.foto2) {
            <div class="mt-2">
              <img [src]="previews.foto2" alt="foto2" class="img-thumbnail" style="max-width: 220px; object-fit: cover;">
            </div>
          }
        </div>

        <div class="col-md-6">
          <label class="form-label">Foto 3</label>
          <input type="file" class="form-control" accept="image/*" (change)="onFileChange($event, 'foto3')">
          @if (previews.foto3) {
            <div class="mt-2">
              <img [src]="previews.foto3" alt="foto3" class="img-thumbnail" style="max-width: 220px; object-fit: cover;">
            </div>
          }
        </div>

        <div class="col-md-6">
          <label class="form-label">Foto 4</label>
          <input type="file" class="form-control" accept="image/*" (change)="onFileChange($event, 'foto4')">
          @if (previews.foto4) {
            <div class="mt-2">
              <img [src]="previews.foto4" alt="foto4" class="img-thumbnail" style="max-width: 220px; object-fit: cover;">
            </div>
          }
        </div>

        <!-- Progreso -->
        @if (progress() > 0) {
          <div class="col-12">
            <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100">
              <div class="progress-bar" [style.width.%]="progress()">{{ progress() }}%</div>
            </div>
          </div>
        }

      </div>
    </div>

    <div class="card-footer d-flex justify-content-end gap-2 border-0">
      <button type="button" class="btn btn-light" [disabled]="loading()" (click)="resetForm()">Limpiar</button>
      <button
        type="submit"
        class="btn btn-primary"
        [disabled]="loading() || (sector()==='SALUD' ? !selectedPatient : !selectedClient)">
        @if (loading()) { <span class="spinner-border spinner-border-sm me-2"></span> }
        Guardar
      </button>
    </div>
  </form>
</div>

<!-- Modal selector de PACIENTE -->
<app-patient-picker
  [apiBase]="apiBase"
  [token]="tokenStr"
  [isOpen]="patientModalOpen()"
  (closed)="onPatientClose()"
  (selected)="onPatientPicked($event)"
></app-patient-picker>

<!-- Modal selector de CLIENTE -->
<app-client-picker
  [apiBase]="apiBase"
  [token]="tokenStr"
  [isOpen]="clientModalOpen()"
  (closed)="onClientClose()"
  (selected)="onClientPicked($event)"
></app-client-picker>
