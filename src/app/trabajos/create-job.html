<div class="py-3 md:pb-0 pb-28 page-create-job">
  <!-- Header -->
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-xl font-semibold m-0">{{ isEdit() ? 'Editar trabajo' : 'Crear trabajo' }}</h3>
    <a routerLink="/trabajos" class="btn btn-outline-secondary">&larr; Volver</a>
  </div>

  @if (error()) {
    <div class="rounded-lg border border-red-300 bg-red-50 text-red-700 px-4 py-3 text-sm flex gap-3 items-start mb-4" role="alert">
      <i class="bi bi-exclamation-triangle mt-1"></i>
      <div class="font-medium flex-1">{{ error() }}</div>
      <button type="button" class="btn btn-close" (click)="error.set(null)"></button>
    </div>
  }

  <!-- Form -->
  <form class="bg-white rounded-2xl shadow-card border border-slate-200/60" (submit)="$event.preventDefault(); submit()">
    <div class="p-5">
      <div class="grid gap-4 md:grid-cols-12">
        <div class="md:col-span-3">
          <label class="text-sm font-medium text-slate-700">Fecha <span class="text-red-600">*</span></label>
          <div class="relative">
            <i class="bi bi-calendar3 leading-icon"></i>
            <input type="text" placeholder="YYYY-MM-DD" class="form-control with-leading-icon" [(ngModel)]="form.fecha" name="fecha" required appFlatpickr>
          </div>
        </div>

        @if (isEdit()) {
        <div class="md:col-span-3">
          <label class="text-sm font-medium text-slate-700">Estado</label>
          <select class="form-control text-sm" [(ngModel)]="form.estado" name="estado">
            <option [ngValue]="null" disabled>— Selecciona un estado —</option>
            <option *ngFor="let e of estadoOptions" [ngValue]="e.value">{{ e.label }}</option>
          </select>
        </div>
        }

        @if (sector() !== 'SALUD') {
        <div class="md:col-span-6">
          <label class="text-sm font-medium text-slate-700 flex items-center justify-between">
            <span>Cliente <span class="text-red-600">*</span></span>
            @if (selectedClient) { <small class="text-slate-500">ID: {{ selectedClient.id }}</small> }
          </label>
          <div class="flex items-center gap-2">
            <input type="text" class="form-control flex-1" [value]="selectedClient ? (selectedClient.nombre + ' ' + (selectedClient.apellido||'')) : ''" placeholder="Sin seleccionar" readonly>
            <button type="button" class="btn btn-outline-primary" (click)="openClientModal()"><i class="bi bi-search"></i> <span class="ml-1">Seleccionar</span></button>
            <button type="button" class="btn btn-outline-secondary" (click)="clearClient()" [disabled]="!selectedClient">Limpiar</button>
          </div>
          @if (!selectedClient) { <div class="text-xs text-slate-500 mt-1">Debes seleccionar o crear un cliente.</div> }
        </div>
        } @else {
        <div class="md:col-span-6">
          <label class="text-sm font-medium text-slate-700 flex items-center justify-between">
            <span>Paciente <span class="text-red-600">*</span></span>
            @if (selectedPatient) { <small class="text-slate-500">ID: {{ selectedPatient.id }}</small> }
          </label>
          <div class="flex items-center gap-2">
            <input type="text" class="form-control flex-1" [value]="selectedPatient ? (selectedPatient.nombre + ' ' + (selectedPatient.apellido||'')) : ''" placeholder="Sin seleccionar" readonly>
            <button type="button" class="btn btn-outline-success" (click)="openPatientModal()"><i class="bi bi-heart-pulse"></i> <span class="ml-1">Seleccionar</span></button>
            <button type="button" class="btn btn-outline-secondary" (click)="clearPatient()" [disabled]="!selectedPatient">Limpiar</button>
          </div>
          @if (!selectedPatient) { <div class="text-xs text-slate-500 mt-1">Debes seleccionar o crear un paciente.</div> }
        </div>
        }

        <div class="md:col-span-4">
          <label class="text-sm font-medium text-slate-700">Forma de pago <span class="text-red-600">*</span></label>
          <div class="relative" id="mop-select">
            <i class="bi bi-wallet2 leading-icon"></i>
            <i class="bi bi-chevron-down trailing-icon"></i>
            <input type="text" class="form-control pretty-select with-leading-icon with-trailing-icon cursor-pointer" [value]="getFormaPagoLabel()" readonly (click)="mopOpen.set(!mopOpen())">
            @if (mopOpen()) {
              <div class="absolute z-30 mt-1 w-full bg-white border border-slate-200/70 rounded-xl shadow-card max-h-56 overflow-auto py-1">
                <button type="button" class="w-full text-left px-3 py-2 text-sm hover:bg-slate-50 flex items-center gap-2" *ngFor="let f of formasPago" (click)="pickMop(f.id)" [ngClass]="{'bg-primary/5': f.id===form.formaPagoId}">
                  <i class="bi bi-check2" [class.text-primary]="f.id===form.formaPagoId" [class.opacity-0]="f.id!==form.formaPagoId"></i>
                  <span>{{ f.formaPago }}</span>
                </button>
              </div>
            }
          </div>
          @if (mopLoading()) { <div class="text-xs text-slate-500 mt-1">Cargando formas de pago…</div> }
        </div>

        <div class="md:col-span-3">
          <label class="text-sm font-medium text-slate-700">Valor mano de obra</label>
          <input type="text" inputmode="numeric" class="form-control" [ngModel]="formatPeso(form.valorLabor)" (ngModelChange)="onMoneyInput('valorLabor', $event)" name="valorLabor" autocomplete="off">
        </div>
        <div class="md:col-span-3">
          <label class="text-sm font-medium text-slate-700">Valor materiales</label>
          <input type="text" inputmode="numeric" class="form-control" [ngModel]="formatPeso(form.valorMateriales)" (ngModelChange)="onMoneyInput('valorMateriales', $event)" name="valorMateriales" autocomplete="off">
        </div>
        <div class="md:col-span-3">
          <label class="text-sm font-medium text-slate-700">Valor total (auto)</label>
          <input type="text" class="form-control" [value]="formatPeso(totalCalc())" readonly>
          <div class="text-xs text-slate-500 mt-1">Se calcula: mano de obra + materiales.</div>
        </div>
        <div class="md:col-span-3">
          <label class="text-sm font-medium text-slate-700">Ganancias (auto)</label>
          <input type="text" class="form-control" [value]="formatPeso(gananciasCalc())" readonly>
          <div class="text-xs text-slate-500 mt-1">Se calcula: total − materiales.</div>
        </div>

        <div class="md:col-span-12">
          <label class="text-sm font-medium text-slate-700">Descripción de la labor <span class="text-red-600">*</span></label>
          <angular-editor [(ngModel)]="form.descripcionLabor" name="descripcionLabor" [config]="editorConfig"></angular-editor>
          <div class="text-xs text-slate-500 mt-1">Usa negrita, listas, enlaces, etc. (se guardará como HTML).</div>
        </div>

        <div class="md:col-span-12"></div>

        <!-- Fotos: UI moderna tipo dropzone / tarjeta -->
        <div class="md:col-span-12">
          <label class="text-sm font-medium text-slate-700">
            Evidencias (hasta 6 fotos)
            <span class="text-slate-500 font-normal text-xs ml-2" *ngIf="isEdit()">disponibles: {{ getFreeSlotsCount() }}</span>
          </label>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mt-2">
            <!-- Slot 1 -->
            @if (hasSlotContent('foto1')) {
            <div class="relative rounded-xl border border-slate-200/70 bg-slate-50/40 p-3 flex flex-col items-center justify-center text-center hover:border-primary/60 transition-colors"
                 (drop)="onDrop($event, 'foto1')" (dragover)="onDragOver($event, 'foto1')" (dragleave)="onDragLeave($event, 'foto1')"
                 [ngClass]="{'border-primary': dragging['foto1'], 'bg-primary/5': dragging['foto1']}">
              <input id="file-foto1" type="file" class="sr-only" accept="image/*" (change)="onFileChange($event, 'foto1')">
              <label for="file-foto1" class="cursor-pointer w-full"
                [attr.draggable]="previews.foto1 ? true : null"
                (dragstart)="startReorder($event, 'foto1')" (dragend)="endReorder()">
                @if (previews.foto1) { <div class="w-full"><img [src]="previews.foto1" alt="foto1" class="w-full h-36 object-cover rounded-lg border border-slate-200"></div> }
                @if (!previews.foto1 && existingPhotos.foto1 && !markedForDelete.has('foto1')) { <div class="w-full"><img [src]="existingPhotos.foto1" alt="foto1" class="w-full h-36 object-cover rounded-lg border border-slate-200"></div> }
              </label>
              @if (previews.foto1) {
                <div class="mt-2 flex gap-2">
                  <button type="button" class="btn btn-light btn-sm" (click)="openLightbox(previews.foto1!)"><i class="bi bi-eye"></i> Ver</button>
                  <button type="button" class="btn btn-outline-danger btn-sm" (click)="clearPhoto('foto1')"><i class="bi bi-trash"></i></button>
                </div>
              }
              @if (!previews.foto1 && existingPhotos.foto1 && !markedForDelete.has('foto1')) {
                <div class="mt-2 flex gap-2">
                  <button type="button" class="btn btn-outline-primary btn-sm" (click)="armReplace('foto1')"><i class="bi bi-arrow-repeat"></i> Reemplazar</button>
                  <button type="button" class="btn btn-outline-danger btn-sm" (click)="openConfirm('foto1')"><i class="bi bi-trash"></i></button>
                </div>
                <input id="replace-foto1" type="file" class="sr-only" accept="image/*" (change)="onFileChange($event, 'foto1')">
              }
              @if (readingProgress['foto1']) {
                <div class="w-full mt-2">
                  <div class="h-1.5 w-full bg-slate-200 rounded-full overflow-hidden">
                    <div class="h-1.5 bg-primary transition-[width] duration-200" [style.width.%]="readingProgress['foto1'] || 0"></div>
                  </div>
                </div>
              }
            </div>
            }

            <!-- Slot 2 -->
            @if (hasSlotContent('foto2')) {
            <div class="relative rounded-xl border border-slate-200/70 bg-slate-50/40 p-3 flex flex-col items-center justify-center text-center hover:border-primary/60 transition-colors"
                 (drop)="onDrop($event, 'foto2')" (dragover)="onDragOver($event, 'foto2')" (dragleave)="onDragLeave($event, 'foto2')"
                 [ngClass]="{'border-primary': dragging['foto2'], 'bg-primary/5': dragging['foto2']}">
              <input id="file-foto2" type="file" class="sr-only" accept="image/*" (change)="onFileChange($event, 'foto2')">
              <label for="file-foto2" class="cursor-pointer w-full"
                [attr.draggable]="previews.foto2 ? true : null"
                (dragstart)="startReorder($event, 'foto2')" (dragend)="endReorder()">
                @if (previews.foto2) { <div class="w-full"><img [src]="previews.foto2" alt="foto2" class="w-full h-36 object-cover rounded-lg border border-slate-200"></div> }
                @if (!previews.foto2 && existingPhotos.foto2 && !markedForDelete.has('foto2')) { <div class="w-full"><img [src]="existingPhotos.foto2" alt="foto2" class="w-full h-36 object-cover rounded-lg border border-slate-200"></div> }
              </label>
              @if (previews.foto2) {
                <div class="mt-2 flex gap-2">
                  <button type="button" class="btn btn-light btn-sm" (click)="openLightbox(previews.foto2!)"><i class="bi bi-eye"></i> Ver</button>
                  <button type="button" class="btn btn-outline-danger btn-sm" (click)="clearPhoto('foto2')"><i class="bi bi-trash"></i></button>
                </div>
              }
              @if (!previews.foto2 && existingPhotos.foto2 && !markedForDelete.has('foto2')) {
                <div class="mt-2 flex gap-2">
                  <button type="button" class="btn btn-outline-primary btn-sm" (click)="armReplace('foto2')"><i class="bi bi-arrow-repeat"></i> Reemplazar</button>
                  <button type="button" class="btn btn-outline-danger btn-sm" (click)="openConfirm('foto2')"><i class="bi bi-trash"></i></button>
                </div>
                <input id="replace-foto2" type="file" class="sr-only" accept="image/*" (change)="onFileChange($event, 'foto2')">
              }
              @if (readingProgress['foto2']) {
                <div class="w-full mt-2">
                  <div class="h-1.5 w-full bg-slate-200 rounded-full overflow-hidden">
                    <div class="h-1.5 bg-primary transition-[width] duration-200" [style.width.%]="readingProgress['foto2'] || 0"></div>
                  </div>
                </div>
              }
            </div>
            }

            <!-- Slot 3 -->
            @if (hasSlotContent('foto3')) {
            <div class="relative rounded-xl border border-slate-200/70 bg-slate-50/40 p-3 flex flex-col items-center justify-center text-center hover:border-primary/60 transition-colors"
                 (drop)="onDrop($event, 'foto3')" (dragover)="onDragOver($event, 'foto3')" (dragleave)="onDragLeave($event, 'foto3')"
                 [ngClass]="{'border-primary': dragging['foto3'], 'bg-primary/5': dragging['foto3']}">
              <input id="file-foto3" type="file" class="sr-only" accept="image/*" (change)="onFileChange($event, 'foto3')">
              <label for="file-foto3" class="cursor-pointer w-full"
                [attr.draggable]="previews.foto3 ? true : null"
                (dragstart)="startReorder($event, 'foto3')" (dragend)="endReorder()">
                @if (previews.foto3) { <div class="w-full"><img [src]="previews.foto3" alt="foto3" class="w-full h-36 object-cover rounded-lg border border-slate-200"></div> }
                @if (!previews.foto3 && existingPhotos.foto3 && !markedForDelete.has('foto3')) { <div class="w-full"><img [src]="existingPhotos.foto3" alt="foto3" class="w-full h-36 object-cover rounded-lg border border-slate-200"></div> }
              </label>
              @if (previews.foto3) {
                <div class="mt-2 flex gap-2">
                  <button type="button" class="btn btn-light btn-sm" (click)="openLightbox(previews.foto3!)"><i class="bi bi-eye"></i> Ver</button>
                  <button type="button" class="btn btn-outline-danger btn-sm" (click)="clearPhoto('foto3')"><i class="bi bi-trash"></i></button>
                </div>
              }
              @if (!previews.foto3 && existingPhotos.foto3 && !markedForDelete.has('foto3')) {
                <div class="mt-2 flex gap-2">
                  <button type="button" class="btn btn-outline-primary btn-sm" (click)="armReplace('foto3')"><i class="bi bi-arrow-repeat"></i> Reemplazar</button>
                  <button type="button" class="btn btn-outline-danger btn-sm" (click)="openConfirm('foto3')"><i class="bi bi-trash"></i></button>
                </div>
                <input id="replace-foto3" type="file" class="sr-only" accept="image/*" (change)="onFileChange($event, 'foto3')">
              }
              @if (readingProgress['foto3']) {
                <div class="w-full mt-2">
                  <div class="h-1.5 w-full bg-slate-200 rounded-full overflow-hidden">
                    <div class="h-1.5 bg-primary transition-[width] duration-200" [style.width.%]="readingProgress['foto3'] || 0"></div>
                  </div>
                </div>
              }
            </div>
            }

            <!-- Slot 4 -->
            @if (hasSlotContent('foto4')) {
            <div class="relative rounded-xl border border-slate-200/70 bg-slate-50/40 p-3 flex flex-col items-center justify-center text-center hover:border-primary/60 transition-colors"
                 (drop)="onDrop($event, 'foto4')" (dragover)="onDragOver($event, 'foto4')" (dragleave)="onDragLeave($event, 'foto4')"
                 [ngClass]="{'border-primary': dragging['foto4'], 'bg-primary/5': dragging['foto4']}">
              <input id="file-foto4" type="file" class="sr-only" accept="image/*" (change)="onFileChange($event, 'foto4')">
              <label for="file-foto4" class="cursor-pointer w-full"
                [attr.draggable]="previews.foto4 ? true : null"
                (dragstart)="startReorder($event, 'foto4')" (dragend)="endReorder()">
                @if (previews.foto4) { <div class="w-full"><img [src]="previews.foto4" alt="foto4" class="w-full h-36 object-cover rounded-lg border border-slate-200"></div> }
                @if (!previews.foto4 && existingPhotos.foto4 && !markedForDelete.has('foto4')) { <div class="w-full"><img [src]="existingPhotos.foto4" alt="foto4" class="w-full h-36 object-cover rounded-lg border border-slate-200"></div> }
              </label>
              @if (previews.foto4) {
                <div class="mt-2 flex gap-2">
                  <button type="button" class="btn btn-light btn-sm" (click)="openLightbox(previews.foto4!)"><i class="bi bi-eye"></i> Ver</button>
                  <button type="button" class="btn btn-outline-danger btn-sm" (click)="clearPhoto('foto4')"><i class="bi bi-trash"></i></button>
                </div>
              }
              @if (!previews.foto4 && existingPhotos.foto4 && !markedForDelete.has('foto4')) {
                <div class="mt-2 flex gap-2">
                  <button type="button" class="btn btn-outline-primary btn-sm" (click)="armReplace('foto4')"><i class="bi bi-arrow-repeat"></i> Reemplazar</button>
                  <button type="button" class="btn btn-outline-danger btn-sm" (click)="openConfirm('foto4')"><i class="bi bi-trash"></i></button>
                </div>
                <input id="replace-foto4" type="file" class="sr-only" accept="image/*" (change)="onFileChange($event, 'foto4')">
              }
              @if (readingProgress['foto4']) {
                <div class="w-full mt-2">
                  <div class="h-1.5 w-full bg-slate-200 rounded-full overflow-hidden">
                    <div class="h-1.5 bg-primary transition-[width] duration-200" [style.width.%]="readingProgress['foto4'] || 0"></div>
                  </div>
                </div>
              }
            </div>
            }

            <!-- Slot 5 -->
            @if (hasSlotContent('foto5')) {
            <div class="relative rounded-xl border border-slate-200/70 bg-slate-50/40 p-3 flex flex-col items-center justify-center text-center hover:border-primary/60 transition-colors"
                 (drop)="onDrop($event, 'foto5')" (dragover)="onDragOver($event, 'foto5')" (dragleave)="onDragLeave($event, 'foto5')"
                 [ngClass]="{'border-primary': dragging['foto5'], 'bg-primary/5': dragging['foto5']}">
              <input id="file-foto5" type="file" class="sr-only" accept="image/*" (change)="onFileChange($event, 'foto5')">
              <label for="file-foto5" class="cursor-pointer w-full"
                [attr.draggable]="previews.foto5 ? true : null"
                (dragstart)="startReorder($event, 'foto5')" (dragend)="endReorder()">
                @if (previews.foto5) { <div class="w-full"><img [src]="previews.foto5" alt="foto5" class="w-full h-36 object-cover rounded-lg border border-slate-200"></div> }
                @if (!previews.foto5 && existingPhotos.foto5 && !markedForDelete.has('foto5')) { <div class="w-full"><img [src]="existingPhotos.foto5" alt="foto5" class="w-full h-36 object-cover rounded-lg border border-slate-200"></div> }
              </label>
              @if (previews.foto5) {
                <div class="mt-2 flex gap-2">
                  <button type="button" class="btn btn-light btn-sm" (click)="openLightbox(previews.foto5!)"><i class="bi bi-eye"></i> Ver</button>
                  <button type="button" class="btn btn-outline-danger btn-sm" (click)="clearPhoto('foto5')"><i class="bi bi-trash"></i></button>
                </div>
              }
              @if (!previews.foto5 && existingPhotos.foto5 && !markedForDelete.has('foto5')) {
                <div class="mt-2 flex gap-2">
                  <button type="button" class="btn btn-outline-primary btn-sm" (click)="armReplace('foto5')"><i class="bi bi-arrow-repeat"></i> Reemplazar</button>
                  <button type="button" class="btn btn-outline-danger btn-sm" (click)="openConfirm('foto5')"><i class="bi bi-trash"></i></button>
                </div>
                <input id="replace-foto5" type="file" class="sr-only" accept="image/*" (change)="onFileChange($event, 'foto5')">
              }
              @if (readingProgress['foto5']) {
                <div class="w-full mt-2">
                  <div class="h-1.5 w-full bg-slate-200 rounded-full overflow-hidden">
                    <div class="h-1.5 bg-primary transition-[width] duration-200" [style.width.%]="readingProgress['foto5'] || 0"></div>
                  </div>
                </div>
              }
            </div>
            }

            <!-- Slot 6 -->
            @if (hasSlotContent('foto6')) {
            <div class="relative rounded-xl border border-slate-200/70 bg-slate-50/40 p-3 flex flex-col items-center justify-center text-center hover:border-primary/60 transition-colors"
                 (drop)="onDrop($event, 'foto6')" (dragover)="onDragOver($event, 'foto6')" (dragleave)="onDragLeave($event, 'foto6')"
                 [ngClass]="{'border-primary': dragging['foto6'], 'bg-primary/5': dragging['foto6']}">
              <input id="file-foto6" type="file" class="sr-only" accept="image/*" (change)="onFileChange($event, 'foto6')">
              <label for="file-foto6" class="cursor-pointer w-full"
                [attr.draggable]="previews.foto6 ? true : null"
                (dragstart)="startReorder($event, 'foto6')" (dragend)="endReorder()">
                @if (previews.foto6) { <div class="w-full"><img [src]="previews.foto6" alt="foto6" class="w-full h-36 object-cover rounded-lg border border-slate-200"></div> }
                @if (!previews.foto6 && existingPhotos.foto6 && !markedForDelete.has('foto6')) { <div class="w-full"><img [src]="existingPhotos.foto6" alt="foto6" class="w-full h-36 object-cover rounded-lg border border-slate-200"></div> }
              </label>
              @if (previews.foto6) {
                <div class="mt-2 flex gap-2">
                  <button type="button" class="btn btn-light btn-sm" (click)="openLightbox(previews.foto6!)"><i class="bi bi-eye"></i> Ver</button>
                  <button type="button" class="btn btn-outline-danger btn-sm" (click)="clearPhoto('foto6')"><i class="bi bi-trash"></i></button>
                </div>
              }
              @if (!previews.foto6 && existingPhotos.foto6 && !markedForDelete.has('foto6')) {
                <div class="mt-2 flex gap-2">
                  <button type="button" class="btn btn-outline-primary btn-sm" (click)="armReplace('foto6')"><i class="bi bi-arrow-repeat"></i> Reemplazar</button>
                  <button type="button" class="btn btn-outline-danger btn-sm" (click)="openConfirm('foto6')"><i class="bi bi-trash"></i></button>
                </div>
                <input id="replace-foto6" type="file" class="sr-only" accept="image/*" (change)="onFileChange($event, 'foto6')">
              }
              @if (readingProgress['foto6']) {
                <div class="w-full mt-2">
                  <div class="h-1.5 w-full bg-slate-200 rounded-full overflow-hidden">
                    <div class="h-1.5 bg-primary transition-[width] duration-200" [style.width.%]="readingProgress['foto6'] || 0"></div>
                  </div>
                </div>
              }
            </div>
            }
            <!-- Tile "+" para añadir más (solo si hay espacios libres) -->
            @if (getFreeSlotsCount() > 0) {
            <div class="relative rounded-xl border-2 border-dashed border-slate-300/80 bg-slate-50/50 p-3 flex flex-col items-center justify-center text-center hover:border-primary/60 hover:bg-primary/5 transition-colors"
                 (drop)="!isProcessingAny() && onAddDrop($event)" (dragover)="$event.preventDefault()">
              <input id="file-add" type="file" class="sr-only" accept="image/*" multiple (change)="onAddInputChange($event)" [disabled]="isProcessingAny()">
              <label for="file-add" class="w-full py-8 flex flex-col items-center gap-2"
                     [ngClass]="{'cursor-not-allowed opacity-60': isProcessingAny(), 'cursor-pointer': !isProcessingAny()}"
                     [attr.aria-disabled]="isProcessingAny()">
                <i class="bi bi-plus-circle text-3xl text-slate-500" [class.text-primary]="!isProcessingAny()"></i>
                <div class="text-sm text-slate-600" *ngIf="!isProcessingAny()"><span class="text-primary">Añadir fotos</span> o arrastrar aquí</div>
                <div class="text-sm text-slate-600" *ngIf="isProcessingAny()">Procesando imagen… espera para añadir la siguiente</div>
                <div class="text-xs text-slate-500">Espacios disponibles: {{ getFreeSlotsCount() }}</div>
              </label>
            </div>
            }
          </div>
          <div class="text-xs text-slate-500 mt-2">
            Consejo: fotos horizontales se ven mejor. Acepta hasta 6 archivos.
            @if (isEdit()) { <span class="ml-1">Disponibles: {{ getFreeSlotsCount() }}</span> }
            @if (!isEdit() && getFreeSlotsCount() === 0) { <span class="ml-1">Ya alcanzaste el máximo (6).</span> }
          </div>
        </div>

        @if (progress() > 0) {
          <div class="md:col-span-12">
            <div class="h-2 w-full bg-slate-200 rounded-full overflow-hidden" role="progressbar" aria-valuemin="0" aria-valuemax="100">
              <div class="h-2 bg-primary rounded-full transition-[width] duration-300" [style.width.%]="progress()"></div>
            </div>
            <div class="text-xs text-slate-500 mt-1">{{ progress() }}%</div>
          </div>
        }
      </div>
    </div>

    <div class="px-5 py-3 border-t border-slate-200 hidden md:flex justify-end gap-2">
      <button type="button" class="btn btn-light" [disabled]="loading()" (click)="cancel()">Cancelar</button>
      <button type="submit" class="btn btn-primary" appSparkles [disabled]="loading() || (sector()==='SALUD' ? !selectedPatient : !selectedClient)"> @if (loading()) { <span class="spinner-border spinner-border-sm mr-2"></span> } {{ isEdit() ? 'Guardar cambios' : 'Guardar' }}</button>
    </div>
  </form>

  <!-- FAB móvil: acciones flotantes apiladas a la derecha -->
  <div class="dr-fab-wrap md:hidden">
    <button type="button" class="dr-fab btn btn-primary" (click)="submit()" [disabled]="loading() || (sector()==='SALUD' ? !selectedPatient : !selectedClient)" aria-label="Guardar">
      @if (loading()) { <span class="spinner-border spinner-border-sm mr-1"></span> } <i class="bi bi-check2"></i>
    </button>
    <button type="button" class="dr-fab btn btn-light" (click)="cancel()" [disabled]="loading()" aria-label="Cancelar">
      <i class="bi bi-x"></i>
    </button>
  </div>
</div>

<!-- Modal confirmar cancelar con cambios -->
@if (cancelConfirmOpen()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/40" (click)="closeCancelConfirm()"></div>
    <div class="relative bg-white rounded-2xl shadow-card w-full max-w-sm mx-4 p-5 border border-slate-200/70">
      <div class="flex items-start justify-between mb-3">
        <h5 class="font-semibold flex items-center gap-2 text-slate-800 m-0"><i class="bi bi-exclamation-triangle text-amber-500"></i><span>Descartar cambios</span></h5>
        <button type="button" (click)="closeCancelConfirm()" class="btn btn-close" aria-label="Cerrar"></button>
      </div>
      <div class="space-y-2 text-sm">
        <p class="m-0">Tienes cambios sin guardar. ¿Deseas descartarlos y salir?</p>
      </div>
      <div class="flex justify-end gap-2 mt-5">
        <button type="button" (click)="closeCancelConfirm()" [disabled]="loading()" class="btn btn-light">Seguir editando</button>
        <button type="button" (click)="proceedCancel()" [disabled]="loading()" class="btn btn-outline-danger">Descartar</button>
      </div>
    </div>
  </div>
}

<!-- Lightbox para previews en creación -->
@if (lightboxOpen()) {
  <div class="lightbox-overlay" (wheel)="onWheelLightbox($event)" (click)="closeLightbox()">
    <div class="lightbox-toolbar" (click)="$event.stopPropagation()">
      <button type="button" class="btn btn-light" (click)="zoomOut()" [disabled]="zoom()<=1"><i class="bi bi-zoom-out"></i></button>
      <button type="button" class="btn btn-light" (click)="zoomIn()"><i class="bi bi-zoom-in"></i></button>
      <button type="button" class="btn btn-light" (click)="resetZoom()"><i class="bi bi-aspect-ratio"></i></button>
      <button type="button" class="btn btn-light" (click)="closeLightbox()"><i class="bi bi-x"></i></button>
    </div>
    <div class="lightbox-stage" (click)="$event.stopPropagation()">
      <img [src]="lightboxSrc() || ''" alt="preview"
           class="lightbox-image"
           [style.transform]="'translate(' + posX() + 'px,' + posY() + 'px) scale(' + zoom() + ')'"
           [style.cursor]="zoom()>1 ? 'grab' : 'zoom-in'"
           (mousedown)="onLightboxMouseDown($event)"
           (mousemove)="onLightboxMouseMove($event)"
           (mouseup)="onLightboxMouseUp()"
           (mouseleave)="onLightboxMouseLeave()"
           (dblclick)="onLightboxDblClick()"
           (touchstart)="onLightboxTouchStart($event)"
           (touchmove)="onLightboxTouchMove($event)"
           (touchend)="onLightboxTouchEnd($event)"
      />
    </div>
  </div>
}

<!-- Modal selector de PACIENTE -->
<app-patient-picker [apiBase]="apiBase" [token]="tokenStr" [isOpen]="patientModalOpen()" (closed)="onPatientClose()" (selected)="onPatientPicked($event)"></app-patient-picker>

<!-- Modal selector de CLIENTE -->
<app-client-picker [apiBase]="apiBase" [token]="tokenStr" [isOpen]="clientModalOpen()" (closed)="onClientClose()" (selected)="onClientPicked($event)"></app-client-picker>

<!-- Modal confirmar eliminación de evidencia -->
@if (confirmOpen()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative bg-white rounded-xl shadow-xl w-full max-w-sm mx-4 p-4">
      <h4 class="text-base font-semibold mb-2">Eliminar evidencia</h4>
      <p class="text-sm text-slate-600">¿Seguro que deseas eliminar esta foto? Podrás subir otra después.</p>
      <div class="mt-4 flex justify-end gap-2">
        <button type="button" class="btn btn-light" (click)="cancelConfirm()">Cancelar</button>
        <button type="button" class="btn btn-outline-danger" (click)="confirmDelete()">Eliminar</button>
      </div>
    </div>
  </div>
}
