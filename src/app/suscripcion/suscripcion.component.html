<div class="mx-auto max-w-5xl p-4">
  <div class="card mb-4">
    <div class="card-body">
      <div class="flex items-center justify-between gap-4">
        <div>
          <h1 class="text-xl font-semibold mb-1">Mi suscripción</h1>
          <p class="text-slate-600">Elige un plan mensual según tus necesidades. Puedes cambiarlo cuando quieras.</p>
        </div>
        <a routerLink="/perfil" class="btn btn-secondary"><i class="bi bi-person me-1"></i>Volver a perfil</a>
      </div>
      <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
        <div class="p-3 rounded-md bg-slate-50 border border-slate-200">
          <div class="text-[11px] uppercase text-slate-600">Plan actual</div>
          <div class="text-lg font-semibold">{{ current().name }}</div>
          <div class="text-slate-600 text-sm">$ {{ current().priceCop }} COP/mes</div>
        </div>
      </div>
    </div>
  </div>

  @if (loading()) {
    <div class="text-center py-8">
      <i class="bi bi-arrow-repeat animate-spin text-2xl mb-2"></i>
      <p class="text-slate-600">Cargando planes...</p>
    </div>
  } @else if (error() && plans().length === 0) {
    <div class="alert alert-danger">
      <i class="bi bi-exclamation-triangle me-2"></i>
      {{ error() }}
      <button type="button" class="btn btn-sm btn-outline-danger ms-2" (click)="loadPlans()">
        Reintentar
      </button>
    </div>
  } @else {
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      @for (p of plans(); track p.publicId) {
        <label class="plan-card" [class.selected]="isSelected(p)" (click)="select(p)">
          <div class="flex items-center justify-between">
            <h3 class="title">{{ p.name }}</h3>
            @if (p.popular) {<span class="badge">Más popular</span>}
          </div>
          <div class="price">
            $ {{ getPriceForPeriod(p) }} 
            <span class="per">COP{{ selectedPeriod() === 'ANNUAL' ? '/año' : '/mes' }}</span>
            @if (selectedPeriod() === 'ANNUAL' && p.priceCop > 0) {
              <div class="text-xs text-green-600 mt-1">¡20% descuento!</div>
            }
          </div>
          <p class="desc">{{ p.description }}</p>
          <ul class="features">
            <li><i class="bi bi-people"></i> Hasta {{ p.limits.maxUsers }} usuarios</li>
            <li><i class="bi bi-images"></i> {{ p.limits.maxImagesPerJob }} imágenes por trabajo</li>
            <li><i class="bi bi-person-vcard"></i> {{ p.limits.maxClientes | number }} clientes</li>
            <li><i class="bi bi-heart-pulse"></i> {{ p.limits.maxPacientes | number }} pacientes</li>
            <li><i class="bi bi-briefcase"></i> {{ p.limits.maxTrabajos | number }} trabajos</li>
          </ul>
          <div class="mt-3">
            <button type="button" class="btn w-full" [class.btn-primary]="isSelected(p)" [class.btn-outline]="!isSelected(p)">
              {{ isSelected(p) ? 'Seleccionado' : 'Elegir plan' }}
            </button>
          </div>
        </label>
      }
    </div>

    <!-- Controles de período y email -->
    <div class="mt-6 card">
      <div class="card-body">
        <h3 class="text-lg font-semibold mb-4">Configurar suscripción</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Selector de período -->
          <div>
            <label class="form-label">Período de facturación</label>
            <div class="flex gap-2">
              <label class="flex-1">
                <input type="radio" 
                       name="period" 
                       value="MONTHLY" 
                       [checked]="selectedPeriod() === 'MONTHLY'"
                       (change)="selectedPeriod.set('MONTHLY')"
                       class="sr-only">
                <div class="btn btn-outline w-full text-center" 
                     [class.btn-primary]="selectedPeriod() === 'MONTHLY'"
                     [class.btn-outline]="selectedPeriod() !== 'MONTHLY'">
                  Mensual
                </div>
              </label>
              <label class="flex-1">
                <input type="radio" 
                       name="period" 
                       value="ANNUAL" 
                       [checked]="selectedPeriod() === 'ANNUAL'"
                       (change)="selectedPeriod.set('ANNUAL')"
                       class="sr-only">
                <div class="btn btn-outline w-full text-center" 
                     [class.btn-primary]="selectedPeriod() === 'ANNUAL'"
                     [class.btn-outline]="selectedPeriod() !== 'ANNUAL'">
                  Anual <span class="text-xs">(20% desc.)</span>
                </div>
              </label>
            </div>
          </div>

          <!-- Email del comprador -->
          <div>
            <label class="form-label">Email de facturación</label>
            @if (userEmail()) {
              <div class="form-control bg-light text-muted d-flex align-items-center">
                <i class="bi bi-envelope me-2"></i>
                <span>{{ userEmail() }}</span>
              </div>
              <div class="form-text">Se usará el email de tu cuenta para la facturación</div>
            } @else {
              <div class="form-control bg-light text-muted d-flex align-items-center">
                <i class="bi bi-arrow-repeat animate-spin me-2"></i>
                <span>Cargando email...</span>
              </div>
            }
          </div>
        </div>

        @if (success()) {
          <div class="alert alert-success mt-3">
            <i class="bi bi-check-circle me-2"></i>
            {{ success() }}
          </div>
        }

        @if (error()) {
          <div class="alert alert-danger mt-3">
            <i class="bi bi-exclamation-triangle me-2"></i>
            {{ error() }}
            @if (checkoutWindowClosed() && lastCheckoutUrl) {
              <div class="mt-2">
                <button type="button" 
                        class="btn btn-sm btn-outline-primary" 
                        (click)="reopenCheckoutWindow()">
                  <i class="bi bi-arrow-clockwise me-1"></i>
                  Reabrir ventana de pago
                </button>
              </div>
            }
          </div>
        }

        <div class="mt-4 flex items-center gap-3">
          @if (getSelectedPlan()?.priceCop === 0) {
            <button type="button" 
                    class="btn btn-primary" 
                    [disabled]="saving()" 
                    (click)="suscribirse()">
              <i class="bi bi-check me-1" [class.animate-spin]="saving()"></i>
              Activar plan gratuito
            </button>
          } @else {
            <button type="button" 
                    class="btn btn-primary" 
                    [disabled]="saving() || !userEmail().trim() || userProfileService.isLoading()" 
                    (click)="suscribirse()">
              <i class="bi bi-credit-card me-1" [class.animate-spin]="saving()"></i>
              Proceder al pago
              @if (getSelectedPlan()) {
                <span class="ms-1">($ {{ getPriceForPeriod(getSelectedPlan()!) }} COP)</span>
              }
            </button>
          }
        </div>
      </div>
    </div>
  }
</div>
