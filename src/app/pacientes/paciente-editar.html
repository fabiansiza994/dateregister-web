<div class="py-3">
  <div class="flex flex-wrap items-center justify-between mb-4 gap-2">
    <div>
      <h3 class="text-xl font-semibold m-0">Editar paciente</h3>
      <p class="text-xs text-slate-500 m-0">Actualiza los datos del paciente</p>
    </div>
    <div>
      <button class="btn btn-outline-secondary" (click)="cancel()">&larr; Volver</button>
    </div>
  </div>

  @if (error()) { <div class="rounded-lg border border-red-300 bg-red-50 text-red-700 px-4 py-3 text-sm flex gap-3 items-start mb-4" role="alert"><i class="bi bi-exclamation-triangle mt-1"></i><div class="font-medium flex-1">{{ error() }}</div><button type="button" class="btn btn-close" (click)="error.set(null)"></button></div> }

  @if (loading()) {
    <div class="text-center py-4 text-slate-500"><span class="spinner-border spinner-border-sm"></span> Cargando…</div>
  } @else {
    @if (paciente()) {
      <form class="bg-white rounded-2xl shadow-card border border-slate-200/70" (ngSubmit)="actualizar()">
        <div class="p-5 pb-20 md:pb-5">
          <div class="grid gap-4 md:grid-cols-12">

            <div class="md:col-span-6">
              <label class="text-sm font-medium text-slate-700">Nombre <span class="text-red-600">*</span></label>
              <input
                class="form-control"
                [class.is-invalid]="fieldErrors()['nombre']"
                [ngModel]="paciente()!.nombre"
                (ngModelChange)="onField('nombre', $event)"
                name="nombre" required>
              @if (fieldErrors()['nombre']) {
                <div class="invalid-feedback">{{ fieldErrors()['nombre'] }}</div>
              }
            </div>

            <div class="md:col-span-6">
              <label class="text-sm font-medium text-slate-700">Apellido</label>
              <input
                class="form-control"
                [class.is-invalid]="fieldErrors()['apellido']"
                [ngModel]="paciente()!.apellido"
                (ngModelChange)="onField('apellido', $event)"
                name="apellido">
              @if (fieldErrors()['apellido']) {
                <div class="invalid-feedback">{{ fieldErrors()['apellido'] }}</div>
              }
            </div>

            <div class="md:col-span-6">
              <label class="text-sm font-medium text-slate-700">Identificación</label>
              <input
                class="form-control"
                [class.is-invalid]="fieldErrors()['documento']"
                [ngModel]="paciente()!.documento"
                (ngModelChange)="onField('documento', $event)"
                name="documento">
              @if (fieldErrors()['documento']) {
                <div class="invalid-feedback">{{ fieldErrors()['documento'] }}</div>
              }
            </div>

            <div class="md:col-span-6">
              <label class="text-sm font-medium text-slate-700">Teléfono</label>
              <input
                class="form-control"
                [class.is-invalid]="fieldErrors()['telefono']"
                [ngModel]="paciente()!.telefono"
                (ngModelChange)="onField('telefono', $event)"
                name="telefono">
              @if (fieldErrors()['telefono']) {
                <div class="invalid-feedback">{{ fieldErrors()['telefono'] }}</div>
              }
            </div>

            <div class="md:col-span-6">
              <label class="text-sm font-medium text-slate-700">Email</label>
              <input
                type="email"
                class="form-control"
                [class.is-invalid]="fieldErrors()['email']"
                [ngModel]="paciente()!.email"
                (ngModelChange)="onField('email', $event)"
                name="email">
              @if (fieldErrors()['email']) {
                <div class="invalid-feedback">{{ fieldErrors()['email'] }}</div>
              }
            </div>

            <div class="md:col-span-6">
              <label class="text-sm font-medium text-slate-700">Dirección</label>
              <input
                class="form-control"
                [class.is-invalid]="fieldErrors()['direccion']"
                [ngModel]="paciente()!.direccion"
                (ngModelChange)="onField('direccion', $event)"
                name="direccion">
              @if (fieldErrors()['direccion']) {
                <div class="invalid-feedback">{{ fieldErrors()['direccion'] }}</div>
              }
            </div>

            <div class="md:col-span-6 flex items-center">
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="estadoSwitch"
                  [checked]="paciente()?.estado === 'ACTIVO'"
                  (change)="toggleEstado($event)"
                  [disabled]="loading()"
                />
                <label class="form-check-label ms-2" for="estadoSwitch">
                  Estado:
                  <span class="px-2 py-0.5 rounded-full text-[11px] font-medium" [class.bg-green-100]="(paciente()?.estado === 'ACTIVO')" [class.text-green-700]="(paciente()?.estado === 'ACTIVO')" [class.bg-slate-200]="(paciente()?.estado !== 'ACTIVO')" [class.text-slate-600]="(paciente()?.estado !== 'ACTIVO')">{{ paciente()?.estado || 'INACTIVO' }}</span>
                </label>
              </div>
            </div>

          </div>
        </div>

        <div class="px-5 py-3 bg-slate-50/60 hidden md:flex justify-end gap-2 border-0">
          <button type="button" class="btn btn-light" (click)="cancel()">Cancelar</button>
          <button type="submit" class="btn btn-primary" [disabled]="loading() || !formOk()">@if (loading()) { <span class="spinner-border spinner-border-sm mr-2"></span> } Guardar cambios</button>
        </div>
      </form>
    } @else {
      <div class="rounded-xl border border-slate-200/70 bg-white p-4 text-center text-slate-500">No se encontró el paciente.</div>
    }
  }
</div>

<!-- FAB móvil -->
<div class="dr-fab-wrap md:hidden">
  <button type="button" class="btn btn-light dr-fab" (click)="cancel()"><i class="bi bi-x-circle"></i><span>Cancelar</span></button>
  <button type="button" class="btn btn-primary dr-fab" (click)="actualizar()" [disabled]="loading() || !formOk()">@if (loading()) { <span class="spinner-border spinner-border-sm me-1"></span> } <i class="bi bi-save"></i><span>Guardar</span></button>
</div>

<!-- Modal confirmar cancelar -->
@if (cancelConfirmOpen()) {
  <div class="fixed inset-0 z-[60] flex items-center justify-center">
    <div class="fixed inset-0 bg-black/40 z-[55]" (click)="closeCancelConfirm()"></div>
    <div class="relative w-full max-w-md mx-auto z-[65]">
      <div class="bg-white rounded-2xl shadow-card p-5 border border-slate-200/70">
        <div class="flex items-start justify-between mb-2">
          <h5 class="font-semibold m-0 flex items-center gap-2"><i class="bi bi-exclamation-octagon text-warning"></i><span>Descartar cambios</span></h5>
          <button type="button" class="btn btn-close" (click)="closeCancelConfirm()" aria-label="Cerrar"></button>
        </div>
        <p class="m-0 text-slate-600 text-sm">Tienes cambios sin guardar. ¿Deseas descartarlos y volver al listado?</p>
        <div class="flex justify-end gap-2 mt-4">
          <button type="button" class="btn btn-outline-secondary" (click)="closeCancelConfirm()">Seguir editando</button>
          <button type="button" class="btn btn-danger" (click)="proceedCancel()">Descartar</button>
        </div>
      </div>
    </div>
  </div>
}
