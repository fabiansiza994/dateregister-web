<div class="max-w-screen-lg mx-auto px-4 py-4">
  <form class="bg-white rounded-2xl shadow-card border border-slate-200/70" (submit)="$event.preventDefault(); create()">
    <div class="p-5 pb-20 md:pb-5">
      <div class="flex flex-wrap items-center justify-between mb-3 gap-3">
        <div class="space-y-0.5">
          <h3 class="text-xl font-semibold m-0 flex items-center gap-2"><i class="bi bi-person-plus text-primary"></i><span>Crear paciente</span></h3>
          <p class="text-xs text-slate-500 m-0">Completa la información básica y, si deseas, datos adicionales</p>
        </div>
        
      </div>

      @if (errorGlobal()) { <div class="rounded-lg border border-red-300 bg-red-50 text-red-700 px-4 py-3 text-sm flex gap-3 items-start mb-3" role="alert"><i class="bi bi-exclamation-triangle mt-1"></i><div class="font-medium flex-1">{{ errorGlobal() }}</div><button type="button" class="btn btn-close" (click)="errorGlobal.set(null)"></button></div> }
      <div class="grid gap-4 md:grid-cols-12">
        <!-- Nombre -->
        <div class="md:col-span-4">
          <label class="text-sm font-medium text-slate-700">Nombre <span class="text-red-600">*</span></label>
          <input type="text" class="form-control"
                 [class.is-invalid]="fieldErrors()['nombre']"
                 [ngModel]="model().nombre"
                 (ngModelChange)="onField('nombre', $event)" name="nombre"
                 placeholder="Ana" autocomplete="off" />
          @if (fieldErrors()['nombre']) {
            <div class="invalid-feedback">{{ fieldErrors()['nombre'] }}</div>
          }
        </div>

        <!-- Apellido -->
        <div class="md:col-span-4">
          <label class="text-sm font-medium text-slate-700">Apellido</label>
          <input type="text" class="form-control"
                 [class.is-invalid]="fieldErrors()['apellido']"
                 [ngModel]="model().apellido"
                 (ngModelChange)="onField('apellido', $event)" name="apellido"
                 placeholder="Pérez" autocomplete="off" />
          @if (fieldErrors()['apellido']) {
            <div class="invalid-feedback">{{ fieldErrors()['apellido'] }}</div>
          }
        </div>

        <!-- Documento -->
        <div class="md:col-span-4">
          <label class="text-sm font-medium text-slate-700">Documento <span class="text-red-600">*</span></label>
          <input type="text" class="form-control"
                 [class.is-invalid]="fieldErrors()['documento']"
                 [ngModel]="model().documento"
                 (ngModelChange)="onField('documento', $event)" name="documento"
                 placeholder="123456789" autocomplete="off" />
          @if (fieldErrors()['documento']) {
            <div class="invalid-feedback">{{ fieldErrors()['documento'] }}</div>
          }
        </div>
      </div>

      <!-- Acordeón de datos adicionales -->
      <div class="mt-4">
        <button type="button" 
                class="flex items-center gap-2 text-sm font-medium text-slate-600 hover:text-slate-800 transition-colors" 
                (click)="toggleAdditionalFields()">
          <i class="bi" [class.bi-chevron-right]="!showAdditionalFields()" [class.bi-chevron-down]="showAdditionalFields()"></i>
          Datos adicionales
        </button>
        
        @if (showAdditionalFields()) {
          <div class="mt-3 p-4 border border-slate-200 rounded-lg bg-slate-50">
            <div class="grid gap-4 md:grid-cols-12">
              <!-- Teléfono -->
              <div class="md:col-span-6">
                <label class="text-sm font-medium text-slate-700">Teléfono</label>
                <input type="text" class="form-control"
                       [class.is-invalid]="fieldErrors()['telefono']"
                       [ngModel]="model().telefono"
                       (ngModelChange)="onField('telefono', $event)" name="telefono"
                       placeholder="(+57) 300 000 0000" autocomplete="off" />
                @if (fieldErrors()['telefono']) {
                  <div class="invalid-feedback">{{ fieldErrors()['telefono'] }}</div>
                }
              </div>

              <!-- Email -->
              <div class="md:col-span-6">
                <label class="text-sm font-medium text-slate-700">Email</label>
                <input type="email" class="form-control"
                       [class.is-invalid]="fieldErrors()['email']"
                       [ngModel]="model().email"
                       (ngModelChange)="onField('email', $event)" name="email"
                       placeholder="paciente@correo.com" autocomplete="off" />
                @if (fieldErrors()['email']) {
                  <div class="invalid-feedback">{{ fieldErrors()['email'] }}</div>
                }
              </div>

              <!-- Dirección -->
              <div class="md:col-span-12">
                <label class="text-sm font-medium text-slate-700">Dirección</label>
                <input type="text" class="form-control"
                       [class.is-invalid]="fieldErrors()['direccion']"
                       [ngModel]="model().direccion"
                       (ngModelChange)="onField('direccion', $event)" name="direccion"
                       placeholder="Calle 123 #45-67" autocomplete="off" />
                @if (fieldErrors()['direccion']) {
                  <div class="invalid-feedback">{{ fieldErrors()['direccion'] }}</div>
                }
              </div>
            </div>
          </div>
        }
      </div>

      <div class="grid gap-4 md:grid-cols-12 mt-4">

        <!-- Buscar cliente -->
        <div class="md:col-span-4">
          <label class="text-sm font-medium text-slate-700">Buscar cliente</label>
          <div class="input-group">
            <input type="text" class="form-control"
                   [(ngModel)]="qCliente" name="qCliente"
                   (keyup.enter)="buscarClientes()"
                   placeholder="Nombre o identificación del cliente" autocomplete="off" />
            <button type="button" class="btn btn-outline-secondary" (click)="buscarClientes()">
              <i class="bi bi-search"></i>
            </button>
          </div>
          <div class="form-text" *ngIf="totalClientes() > 0">
            {{ totalClientes() }} resultado(s)
          </div>
        </div> 

        <!-- Seleccionar cliente -->
        <div class="md:col-span-4">
          <label class="text-sm font-medium text-slate-700">Cliente asociado <span class="text-red-600">*</span></label>
          <select class="form-select"
                  name="clienteId"
                  [class.is-invalid]="fieldErrors()['clienteId']"
                  [ngModel]="model().clienteId"
                  (ngModelChange)="onField('clienteId', $event)">
            <option [ngValue]="null" disabled>— Selecciona —</option>
            <option *ngFor="let c of clientes()" [ngValue]="c.id">
              {{ c.nombre }} {{ c.apellido || '' }} — {{ c.identificacion || 's/ID' }}
            </option>
          </select>
          @if (fieldErrors()['clienteId']) {
            <div class="invalid-feedback">{{ fieldErrors()['clienteId'] }}</div>
          }
        </div>
      </div>
      
      <div class="hidden md:flex justify-end gap-2 mt-4">
        <button type="button" class="btn btn-light" (click)="cancel()">Cancelar</button>
        <button type="submit" class="btn btn-success" [disabled]="loading() || !isValid()">@if (loading()) { <span class="spinner-border spinner-border-sm mr-2" role="status"></span> } Crear paciente</button>
      </div>
    </div>
  </form>

  <!-- FAB móvil -->
  <div class="dr-fab-wrap md:hidden">
    <button type="button" class="btn btn-light dr-fab" (click)="cancel()"><i class="bi bi-x-circle"></i><span>Cancelar</span></button>
    <button type="button" class="btn btn-success dr-fab" (click)="create()" [disabled]="loading() || !isValid()">@if (loading()) { <span class="spinner-border spinner-border-sm me-1"></span> }<i class="bi bi-check2"></i><span>Crear</span></button>
  </div>
</div>

<!-- Modal confirmar cancelar -->
@if (cancelConfirmOpen()) {
  <div class="fixed inset-0 z-[60] d-flex align-items-center justify-content-center">
    <div class="fixed inset-0 bg-black/40 z-[55]" (click)="closeCancelConfirm()"></div>
    <div class="position-relative w-100" style="max-width: 28rem; z-index:65;">
      <div class="bg-white rounded-4 shadow p-4 border border-slate-200/70">
        <div class="d-flex align-items-start justify-content-between mb-2">
          <h5 class="fw-semibold m-0 d-flex align-items-center gap-2"><i class="bi bi-exclamation-octagon text-warning"></i><span>Descartar cambios</span></h5>
          <button type="button" class="btn btn-close" (click)="closeCancelConfirm()" aria-label="Cerrar"></button>
        </div>
        <p class="mb-0 text-muted">Tienes cambios sin guardar. ¿Deseas descartarlos y volver al listado?</p>
        <div class="d-flex justify-content-end gap-2 mt-4">
          <button type="button" class="btn btn-outline-secondary" (click)="closeCancelConfirm()">Seguir editando</button>
          <button type="button" class="btn btn-danger" (click)="proceedCancel()">Descartar</button>
        </div>
      </div>
    </div>
  </div>
}
